<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Chunk Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* Dual Range Slider Styles */
        .dual-range-container {
            position: relative;
            width: 100%;
            height: 24px;
            display: flex;
            align-items: center;
        }
        
        .dual-slider-input {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            appearance: none;
            -webkit-appearance: none;
            background: transparent;
            z-index: 10;
            margin: 0;
        }

        .dual-slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            pointer-events: auto;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            margin-top: -6px;
            position: relative;
            z-index: 20;
        }
        
        .dual-slider-input::-moz-range-thumb {
            pointer-events: auto;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            z-index: 20;
        }

        .dual-slider-input::-webkit-slider-runnable-track { background: transparent; height: 4px; }
        .dual-slider-input::-moz-range-track { background: transparent; height: 4px; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const IconBase = ({ children, className }) => <span className={`inline-flex items-center justify-center ${className}`}>{children}</span>;
        const Play = ({ className }) => <IconBase className={className}>â–¶</IconBase>;
        const Pause = ({ className }) => <IconBase className={className}>â¸</IconBase>;
        const BookOpen = ({ className }) => <IconBase className={className}>ğŸ“–</IconBase>;
        const Info = ({ className }) => <IconBase className={className}>â„¹ï¸</IconBase>;
        const Settings = ({ className }) => <IconBase className={className}>âš™ï¸</IconBase>;
        const ChevronRight = ({ className }) => <IconBase className={className}>â€º</IconBase>;
        const ChevronLeft = ({ className }) => <IconBase className={className}>â€¹</IconBase>;
        const Upload = ({ className }) => <IconBase className={className}>ğŸ“¤</IconBase>;
        const FileText = ({ className }) => <IconBase className={className}>ğŸ“„</IconBase>;
        const Music = ({ className }) => <IconBase className={className}>ğŸµ</IconBase>;
        const X = ({ className }) => <IconBase className={className}>âœ•</IconBase>;
        const Save = ({ className }) => <IconBase className={className}>ğŸ’¾</IconBase>;
        const Trash2 = ({ className }) => <IconBase className={className}>ğŸ—‘</IconBase>;
        const Loader2 = ({ className }) => <IconBase className={`${className} animate-spin`}>âŒ›</IconBase>;
        const AlertCircle = ({ className }) => <IconBase className={className}>âš ï¸</IconBase>;
        const ListIcon = ({ className }) => <IconBase className={className}>â˜°</IconBase>;
        const Eye = ({ className }) => <IconBase className={className}>ğŸ‘ï¸</IconBase>;
        const EyeOff = ({ className }) => <IconBase className={className}>ğŸ™ˆ</IconBase>;
        const FilterIcon = ({ className }) => <IconBase className={className}>âš¡</IconBase>;
        const PenTool = ({ className }) => <IconBase className={className}>âœï¸</IconBase>;
        const Robot = ({ className }) => <IconBase className={className}>ğŸ¤–</IconBase>;
        const Shuffle = ({ className }) => <IconBase className={className}>ğŸ”€</IconBase>;
        const Copy = ({ className }) => <IconBase className={className}>ğŸ“‹</IconBase>;
        const Clock = ({ className }) => <IconBase className={className}>â±</IconBase>; // New Clock Icon

        // --- åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ (ãƒ‡ãƒ¢ç”¨) ---
        const DEFAULT_SENTENCES = [
            {
                id: 1,
                level: "Basic",
                text: "My children are so absorbed in their iPads.",
                translation: "å­ä¾›ãŸã¡ã¯iPadã«å¤¢ä¸­ã§ã™ã€‚",
                chunks: [
                    { text: "My children are", label: "Subject + Verb", type: "core", japanese: "ç§ã®å­ä¾›ãŸã¡ã¯ï½ã§ã™" },
                    { text: "so absorbed", label: "Adjective", type: "core", japanese: "ã¨ã¦ã‚‚å¤¢ä¸­ãª" },
                    { text: "in their iPads.", label: "Preposition", type: "modifier", japanese: "å½¼ã‚‰ã®iPadã«" }
                ]
            },
            {
                id: 2,
                level: "Basic",
                text: "I want to go.",
                translation: "è¡ŒããŸã„ã€‚",
                chunks: [
                    { text: "I want", label: "SV", type: "core", japanese: "ç§ã¯ã—ãŸã„" },
                    { text: "to go.", label: "Infinitive", type: "modifier", japanese: "è¡Œãã“ã¨ã‚’" }
                ]
            }
        ];

        // è‰²åˆ†ã‘è¨­å®š
        const TYPE_COLORS = {
            core: "bg-red-100 text-red-800 border-red-200",
            modifier: "bg-green-100 text-green-800 border-green-200",
            connector: "bg-blue-100 text-blue-800 border-blue-200"
        };

        function EnglishChunkMaster() {
            // --- State ---
            const [allSentences, setAllSentences] = useState(DEFAULT_SENTENCES);
            const [sentences, setSentences] = useState(DEFAULT_SENTENCES);
            
            // Chunk Filters
            const [minChunkCount, setMinChunkCount] = useState(1);
            const [maxChunkCount, setMaxChunkCount] = useState(10);
            
            // Random Mode
            const [isRandomMode, setIsRandomMode] = useState(false);
            const [randomCountInput, setRandomCountInput] = useState("5");

            const [isLoading, setIsLoading] = useState(true);
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [mode, setMode] = useState('study'); // 'study' | 'composition' | 'settings'
            const [isPlaying, setIsPlaying] = useState(false);
            const [isNativePlaying, setIsNativePlaying] = useState(false);
            const [nativeAudioError, setNativeAudioError] = useState(false);
            
            const [showMeaning, setShowMeaning] = useState(false);
            const [showCompositionAnswer, setShowCompositionAnswer] = useState(false);

            // Timer State (New)
            const [timer, setTimer] = useState(0);
            const timerRef = useRef(null);

            const [audioMap, setAudioMap] = useState({});
            const audioPlayerRef = useRef(null);
            
            // Imports/Exports
            const [csvInput, setCsvInput] = useState("");
            const [idImportInput, setIdImportInput] = useState("");
            const [importError, setImportError] = useState(null);
            const [jumpIdInput, setJumpIdInput] = useState("");

            const currentSentence = sentences[currentIndex] || null;
            const synthesisRef = useRef(window.speechSynthesis);

            const nativeAudioSrc = currentSentence ? (audioMap[currentSentence.id] || `./audio/${currentSentence.id}.mp3`) : "";

            // --- Computed ---
            const maxPossibleChunks = useMemo(() => {
                if (allSentences.length === 0) return 10;
                return Math.max(...allSentences.map(s => s.chunks.length), 5);
            }, [allSentences]);

            const minPercent = ((minChunkCount - 1) / (maxPossibleChunks - 1)) * 100;
            const maxPercent = ((maxChunkCount - 1) / (maxPossibleChunks - 1)) * 100;

            // --- Effects ---
            
            // Filter
            useEffect(() => {
                if (isRandomMode) return;
                const filtered = allSentences.filter(s => {
                    const count = s.chunks.length;
                    return count >= minChunkCount && count <= maxChunkCount;
                });
                setSentences(filtered);
                if (currentIndex >= filtered.length) setCurrentIndex(0);
            }, [minChunkCount, maxChunkCount, allSentences, isRandomMode]);

            useEffect(() => {
                if (maxChunkCount > maxPossibleChunks) {
                    setMaxChunkCount(maxPossibleChunks);
                }
            }, [maxPossibleChunks]);

            // Auto Load
            useEffect(() => {
                const autoLoadData = async () => {
                    try {
                        setIsLoading(true);
                        const response = await fetch('vocabulary_data.csv');
                        if (!response.ok) throw new Error("vocabulary_data.csv not found");
                        const text = await response.text();
                        if (!text.trim()) throw new Error("Empty CSV");
                        const loaded = parseCSV(text, true);
                        if (loaded) setIsDataLoaded(true);
                    } catch (error) {
                        console.log("Auto-load failed. Using demo mode.");
                        setIsDataLoaded(false);
                    } finally {
                        setIsLoading(false);
                    }
                };
                autoLoadData();
            }, []);

            useEffect(() => {
                return () => {
                    cancelSpeech();
                    Object.values(audioMap).forEach(url => URL.revokeObjectURL(url));
                    clearInterval(timerRef.current); // Cleanup timer
                };
            }, []);

            // Reset handling
            useEffect(() => {
                cancelSpeech();
                stopNativeAudio();
                setNativeAudioError(false);
                setShowMeaning(false);
                setShowCompositionAnswer(false);
            }, [currentIndex, mode, sentences]);

            // --- Timer Logic (New) ---
            useEffect(() => {
                // Clear any existing timer first
                clearInterval(timerRef.current);

                // Start timer ONLY if in composition mode AND answer is NOT shown
                if (mode === 'composition' && !showCompositionAnswer) {
                    const startTime = Date.now();
                    setTimer(0);
                    timerRef.current = setInterval(() => {
                        // Calculate elapsed time in seconds with 1 decimal place
                        setTimer((Date.now() - startTime) / 1000);
                    }, 50); // Update roughly every 50ms for smoothness
                }

                // Cleanup function
                return () => clearInterval(timerRef.current);
            }, [mode, currentIndex, showCompositionAnswer]);


            // --- Functions ---
            
            const handleStartRandom = () => {
                const count = parseInt(randomCountInput, 10);
                if (isNaN(count) || count <= 0) {
                    alert("æœ‰åŠ¹ãªæ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
                const pool = allSentences.filter(s => {
                    const c = s.chunks.length;
                    return c >= minChunkCount && c <= maxChunkCount;
                });
                if (pool.length === 0) {
                    alert("ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                    return;
                }
                const shuffled = [...pool].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, count);
                setSentences(selected);
                setIsRandomMode(true);
                setCurrentIndex(0);
                alert(`${pool.length}ä»¶ä¸­ã‹ã‚‰ ${selected.length}ä»¶ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã¾ã—ãŸï¼`);
            };

            const handleExitRandom = () => {
                setIsRandomMode(false);
            };

            const handleExportIds = () => {
                const ids = sentences.map(s => s.id).join(', ');
                const textArea = document.createElement("textarea");
                textArea.value = ids;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert(`IDãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ (${sentences.length}ä»¶)`);
                } catch (err) {
                    console.error('Copy failed', err);
                    alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
                document.body.removeChild(textArea);
            };

            const handleImportIds = () => {
                if (!idImportInput.trim()) return;
                const ids = idImportInput.split(/[,ã€\s]+/).map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
                if (ids.length === 0) {
                    alert("æœ‰åŠ¹ãªIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                    return;
                }
                const sentenceMap = new Map(allSentences.map(s => [s.id, s]));
                const restoredSentences = ids.map(id => sentenceMap.get(id)).filter(s => s !== undefined);
                if (restoredSentences.length === 0) {
                    alert("å…¥åŠ›ã•ã‚ŒãŸIDã«ä¸€è‡´ã™ã‚‹å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                    return;
                }
                setSentences(restoredSentences);
                setIsRandomMode(true);
                setMode('study');
                setCurrentIndex(0);
                setIdImportInput("");
                alert(`${restoredSentences.length}ä»¶ã®å•é¡Œã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`);
            };

            const playNativeAudio = () => {
                cancelSpeech();
                if (audioPlayerRef.current && nativeAudioSrc && !nativeAudioError) {
                    return audioPlayerRef.current.play()
                        .then(() => { setIsNativePlaying(true); return true; })
                        .catch(e => { 
                            console.error("Audio playback error:", e); 
                            setNativeAudioError(true); 
                            return false; 
                        });
                }
                return Promise.resolve(false);
            };

            const stopNativeAudio = () => {
                if (audioPlayerRef.current) { audioPlayerRef.current.pause(); audioPlayerRef.current.currentTime = 0; }
                setIsNativePlaying(false);
            };

            const speakText = (text, rate = 1.0, onEnd = () => {}) => {
                stopNativeAudio();
                cancelSpeech();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rate;
                utterance.onend = () => { setIsPlaying(false); onEnd(); };
                utterance.onerror = () => setIsPlaying(false);
                setIsPlaying(true);
                synthesisRef.current.speak(utterance);
            };

            const handleShowAnswer = async () => {
                setShowCompositionAnswer(true);
                // Timer stops automatically via useEffect dependency
                
                if (nativeAudioSrc && !nativeAudioError) {
                    const success = await playNativeAudio();
                    if (!success) {
                        console.log("Fallback to Robot Voice");
                        speakText(currentSentence.text);
                    }
                } else {
                    speakText(currentSentence.text);
                }
            };

            const handleJumpToId = () => {
                const idToJump = parseInt(jumpIdInput, 10);
                if (isNaN(idToJump)) return;
                const targetIndex = sentences.findIndex(s => s.id === idToJump);
                if (targetIndex !== -1) {
                    setCurrentIndex(targetIndex);
                } else {
                    alert(`ID ${idToJump} ã®å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                }
                setJumpIdInput("");
            };

            const handleJumpInputKeyDown = (e) => {
                if (e.key === 'Enter') handleJumpToId();
            };
            
            const parseCSV = (text, isAutoLoad = false) => {
                try {
                    const lines = text.trim().split('\n');
                    const newSentences = lines.map((line, index) => {
                        const cleanLine = line.trim().replace(/^\uFEFF/, '');
                        if (index === 0 && (cleanLine.toLowerCase().startsWith('id') || cleanLine.includes('è‹±æ–‡'))) return null;
                        const parts = line.split('|').map(p => p.trim());
                        if (parts.length < 3) return null;
                        let idVal = parseInt(parts[0], 10);
                        let startIndex = 1;
                        if (isNaN(idVal)) { idVal = Date.now() + index; startIndex = 0; }
                        const sentenceText = parts[startIndex];
                        const translation = parts[startIndex + 1];
                        const chunkRawData = parts.slice(startIndex + 2);
                        const chunks = chunkRawData.map(chunkStr => {
                            const [cText, cLabel, cType, cJp] = chunkStr.split('^').map(s => s?.trim());
                            return { text: cText || "", label: cLabel || "", type: (cType === 'core' || cType === 'modifier' || cType === 'connector') ? cType : 'core', japanese: cJp || "" };
                        }).filter(c => c.text);
                        return { id: idVal, level: "Custom", text: sentenceText, translation: translation, chunks: chunks };
                    }).filter(Boolean);
                    if (newSentences.length === 0) throw new Error("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                    setAllSentences(newSentences);
                    setMode('study');
                    setImportError(null);
                    if (!isAutoLoad) alert(`${newSentences.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`);
                    return true;
                } catch (e) {
                    setImportError(e.message);
                    if (!isAutoLoad) alert(e.message);
                    return false;
                }
            };

            const handleAudioUpload = (e) => {
                const files = Array.from(e.target.files);
                const newAudioMap = { ...audioMap };
                let count = 0;
                files.forEach(file => {
                    const match = file.name.match(/\((\d+)\)/) || file.name.match(/(\d+)/);
                    if (match) {
                        const id = parseInt(match[1], 10);
                        if (newAudioMap[id]) URL.revokeObjectURL(newAudioMap[id]);
                        newAudioMap[id] = URL.createObjectURL(file);
                        count++;
                    }
                });
                setAudioMap(newAudioMap);
                alert(`${count} å€‹ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒ³ã‚¯ã—ã¾ã—ãŸï¼`);
            };

            const clearAudioData = () => {
                Object.values(audioMap).forEach(url => URL.revokeObjectURL(url));
                setAudioMap({});
            };

            const cancelSpeech = () => {
                if (synthesisRef.current) { synthesisRef.current.cancel(); setIsPlaying(false); }
            };

            const speakChunksWithPause = async () => {
                if (!currentSentence) return;
                stopNativeAudio();
                cancelSpeech();
                setIsPlaying(true);
                const speakChunk = (index) => {
                    if (index >= currentSentence.chunks.length) { setIsPlaying(false); return; }
                    const chunk = currentSentence.chunks[index];
                    const utterance = new SpeechSynthesisUtterance(chunk.text);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.9;
                    utterance.onend = () => { setTimeout(() => speakChunk(index + 1), 800); };
                    synthesisRef.current.speak(utterance);
                };
                speakChunk(0);
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 text-gray-500">
                        <div className="flex flex-col items-center gap-2">
                            <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
                            <p className="text-sm font-medium">Loading data...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-20">
                    <audio ref={audioPlayerRef} src={nativeAudioSrc} onEnded={()=> setIsNativePlaying(false)} onError={() => { setIsNativePlaying(false); setNativeAudioError(true); }} />

                    <header className="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-20">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <h1 className="text-lg font-bold flex items-center gap-2">
                                <Settings className="w-5 h-5 text-indigo-400" />
                                English Chunk Master
                            </h1>
                            <div className="flex items-center gap-2">
                                {isDataLoaded ? <span className="text-[10px] bg-green-600 px-2 py-0.5 rounded-full font-bold">CSVèª­è¾¼æ¸ˆ</span> : <span className="text-[10px] bg-gray-600 px-2 py-0.5 rounded-full font-bold">ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</span>}
                                <button onClick={()=> setMode(mode === 'settings' ? 'study' : 'settings')} className={`p-2 rounded-full transition ${mode === 'settings' ? 'bg-slate-600' : 'hover:bg-slate-700'}`}>
                                    {mode === 'settings' ? <X className="w-5 h-5" /> : <Settings className="w-5 h-5" />}
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-4">
                        {!isDataLoaded && mode !== 'settings' && (
                            <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 text-xs p-3 rounded-lg flex items-start gap-2 animate-fadeIn">
                                <AlertCircle className="w-4 h-4 shrink-0 mt-0.5" />
                                <div><p className="font-bold">ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­</p><p>vocabulary_data.csvãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p></div>
                            </div>
                        )}

                        {mode === 'settings' ? (
                            <div className="space-y-6 animate-fadeIn">
                                {/* è¨­å®šç”»é¢ */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><FileText className="w-5 h-5 text-indigo-600" />ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</h2>
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-6 text-sm text-blue-800">
                                        <p className="font-bold flex items-center gap-2 mb-1"><Info className="w-4 h-4" />è‡ªå‹•èª­ã¿è¾¼ã¿ã«ã¤ã„ã¦</p>
                                        <p className="text-xs leading-relaxed opacity-90">ã‚¢ãƒ—ãƒªã¨åŒã˜å ´æ‰€ã« <code>vocabulary_data.csv</code> ã‚’ç½®ãã¨è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚<br />éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¯ <code>1.mp3</code> ã®ã‚ˆã†ã«IDã«å¯¾å¿œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã§ç½®ã„ã¦ãã ã•ã„ã€‚</p>
                                    </div>
                                    <div className="mb-6">
                                        <label className="block text-sm font-bold text-gray-700 mb-2">æ‰‹å‹•ã§CSVãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘</label>
                                        <textarea className="w-full h-32 p-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono" placeholder="ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..." value={csvInput} onChange={(e)=> setCsvInput(e.target.value)} />
                                        {importError && <p className="text-red-500 text-xs mt-2">{importError}</p>}
                                        <button onClick={() => parseCSV(csvInput)} className="mt-3 w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2"><Save className="w-4 h-4" />CSVã‚’åæ˜ ã™ã‚‹</button>
                                    </div>

                                    {/* ID Import Section */}
                                    <div className="border-t pt-6 mb-6">
                                        <h3 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Shuffle className="w-4 h-4 text-purple-500" />å­¦ç¿’ã‚»ãƒƒãƒˆã®å¾©å…ƒ (IDãƒªã‚¹ãƒˆ)</h3>
                                        <label className="block text-xs text-gray-500 mb-2">ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸIDãƒªã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ã€åŒã˜å•é¡Œã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚</label>
                                        <input 
                                            type="text" 
                                            value={idImportInput}
                                            onChange={(e) => setIdImportInput(e.target.value)}
                                            className="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none font-mono"
                                            placeholder="ä¾‹: 1, 5, 12, 42..."
                                        />
                                        <button onClick={handleImportIds} className="mt-2 w-full bg-purple-600 text-white py-2 rounded-lg font-bold hover:bg-purple-700 transition flex items-center justify-center gap-2">
                                            <Upload className="w-4 h-4" /> IDãƒªã‚¹ãƒˆã‹ã‚‰èª­ã¿è¾¼ã‚€
                                        </button>
                                    </div>

                                    <div className="border-t pt-6">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="text-sm font-bold text-gray-700 flex items-center gap-2"><Music className="w-4 h-4 text-pink-500" />æ‰‹å‹•ã§éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h3>
                                            {Object.keys(audioMap).length > 0 && <button onClick={clearAudioData} className="text-xs text-red-500 flex items-center gap-1"><Trash2 className="w-3 h-3" /> ã‚¯ãƒªã‚¢</button>}
                                        </div>
                                        <label className="block w-full cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 py-4 px-4 rounded-lg border-2 border-dashed border-gray-300 text-center transition">
                                            <span className="flex items-center justify-center gap-2 text-sm"><Upload className="w-4 h-4" /> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (è¤‡æ•°é¸æŠOK)</span>
                                            <input type="file" accept="audio/*" multiple className="hidden" onChange={handleAudioUpload} />
                                        </label>
                                        {Object.keys(audioMap).length > 0 && <div className="mt-3 text-xs text-green-600 font-bold text-center">{Object.keys(audioMap).length} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªãƒ³ã‚¯æ¸ˆã¿</div>}
                                    </div>
                                </div>
                                <button onClick={() => { setAllSentences(DEFAULT_SENTENCES); setAudioMap({}); setIsDataLoaded(false); }} className="w-full py-3 text-sm text-gray-500 hover:text-red-500 transition">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™</button>
                            </div>
                        ) : (
                            <>
                                {/* --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ & ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ --- */}
                                <div className="bg-white px-4 py-3 rounded-xl shadow-sm border border-gray-100 flex gap-4">
                                    <div className="flex flex-col justify-center items-center gap-1 text-indigo-600 min-w-fit pt-1">
                                        <FilterIcon className="w-4 h-4" />
                                        <span className="text-[10px] font-bold uppercase tracking-wider">Filter</span>
                                    </div>
                                    <div className="flex-1 flex flex-col justify-center min-w-0">
                                        {/* Slider & Filter Display */}
                                        <div className={`transition-opacity duration-300 ${isRandomMode ? 'opacity-40 pointer-events-none' : 'opacity-100'}`}>
                                            <div className="flex justify-between items-end mb-1">
                                                <span className="text-xs font-bold text-gray-500">Range: {minChunkCount} - {maxChunkCount} chunks</span>
                                                <span className="text-[10px] font-mono text-gray-400">{sentences.length}/{allSentences.length}</span>
                                            </div>
                                            
                                            {/* Dual Slider Setup (Single Bar) */}
                                            <div className="dual-range-container">
                                                {/* Track Background */}
                                                <div className="absolute w-full h-1 bg-gray-200 rounded-full z-0"></div>
                                                
                                                {/* Selected Range Bar */}
                                                <div 
                                                    className="absolute h-1 bg-indigo-600 rounded-full z-0"
                                                    style={{ 
                                                        left: `${minPercent}%`, 
                                                        width: `${Math.max(0, maxPercent - minPercent)}%` 
                                                    }}
                                                ></div>

                                                {/* Min Slider Input */}
                                                <input 
                                                    type="range" 
                                                    min="1" 
                                                    max={maxPossibleChunks} 
                                                    value={minChunkCount} 
                                                    onChange={(e) => {
                                                        const val = Math.min(Number(e.target.value), maxChunkCount);
                                                        setMinChunkCount(val);
                                                    }} 
                                                    className="dual-slider-input"
                                                    style={{ zIndex: minChunkCount > maxPossibleChunks - 1 ? 20 : 10 }}
                                                />
                                                
                                                {/* Max Slider Input */}
                                                <input 
                                                    type="range" 
                                                    min="1" 
                                                    max={maxPossibleChunks} 
                                                    value={maxChunkCount} 
                                                    onChange={(e) => {
                                                        const val = Math.max(Number(e.target.value), minChunkCount);
                                                        setMaxChunkCount(val);
                                                    }} 
                                                    className="dual-slider-input" 
                                                />
                                            </div>
                                            <div className="flex justify-between text-[9px] text-gray-400 font-mono mt-1">
                                                <span>1</span>
                                                <span>{maxPossibleChunks}</span>
                                            </div>
                                        </div>

                                        {/* Random Mode Controls */}
                                        <div className="mt-2 pt-2 border-t border-gray-100">
                                            {!isRandomMode ? (
                                                <div className="flex items-center gap-2">
                                                    <span className="text-[10px] font-bold text-gray-400">Random:</span>
                                                    <input 
                                                        type="number" 
                                                        min="1" 
                                                        value={randomCountInput} 
                                                        onChange={(e) => setRandomCountInput(e.target.value)}
                                                        className="w-10 h-6 text-xs border border-gray-200 rounded text-center focus:outline-none focus:border-indigo-500"
                                                        placeholder="#"
                                                    />
                                                    <button 
                                                        onClick={handleStartRandom}
                                                        className="px-3 py-1 bg-gray-700 text-white text-[10px] font-bold rounded hover:bg-gray-800 transition flex items-center gap-1"
                                                    >
                                                        <Shuffle className="w-3 h-3" /> Start
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="flex items-center justify-between bg-indigo-50 p-1.5 rounded-lg border border-indigo-100">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[10px] font-bold text-indigo-700 flex items-center gap-1">
                                                            <Shuffle className="w-3 h-3" /> Random ({sentences.length})
                                                        </span>
                                                        <button 
                                                            onClick={handleExportIds}
                                                            className="text-[10px] text-indigo-500 hover:text-indigo-800 underline flex items-center gap-0.5"
                                                            title="IDãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼"
                                                        >
                                                            <Copy className="w-3 h-3" /> Export IDs
                                                        </button>
                                                    </div>
                                                    <button 
                                                        onClick={handleExitRandom}
                                                        className="px-2 py-0.5 bg-white text-indigo-600 border border-indigo-200 text-[10px] font-bold rounded hover:bg-gray-50 transition"
                                                    >
                                                        Exit
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                    </div>
                                </div>

                                {sentences.length === 0 ? (
                                    <div className="text-center py-20 text-gray-500 animate-fadeIn">
                                        <p className="text-lg font-bold mb-2">è¡¨ç¤ºã§ãã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“</p>
                                        <p className="text-sm mb-4">ä¸Šã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§æ¡ä»¶ã‚’ç·©å’Œã—ã¦ãã ã•ã„ã€‚</p>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm gap-2">
                                            <button onClick={() => setCurrentIndex(prev => Math.max(0, prev - 1))} disabled={currentIndex === 0} className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30 transition flex-shrink-0"><ChevronLeft className="w-6 h-6 text-indigo-600" /></button>
                                            <div className="flex-1 flex items-center gap-2 min-w-0">
                                                <div className="flex-1 min-w-0 bg-gray-100 rounded-lg relative">
                                                    <select value={currentIndex} onChange={(e) => setCurrentIndex(Number(e.target.value))} className="w-full h-full bg-transparent p-2 text-sm text-gray-700 font-bold appearance-none outline-none truncate pr-8 z-10 relative cursor-pointer">
                                                        {sentences.map((sentence, idx) => (
                                                            <option key={sentence.id} value={idx}>
                                                                {idx + 1}. [ID:{sentence.id}] {sentence.text.slice(0, 20)}{sentence.text.length > 20 ? '...' : ''} ({sentence.chunks.length} chunks)
                                                            </option>
                                                        ))}
                                                    </select>
                                                    <div className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"><ListIcon className="w-4 h-4" /></div>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <input type="number" value={jumpIdInput} onChange={(e) => setJumpIdInput(e.target.value)} onKeyDown={handleJumpInputKeyDown} className="w-16 p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ID" />
                                                    <button onClick={handleJumpToId} className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-bold">Go</button>
                                                </div>
                                            </div>
                                            <button onClick={() => setCurrentIndex(prev => Math.min(sentences.length - 1, prev + 1))} disabled={currentIndex === sentences.length - 1} className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30 transition flex-shrink-0"><ChevronRight className="w-6 h-6 text-indigo-600" /></button>
                                        </div>

                                        {/* --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ --- */}
                                        <div className="flex bg-gray-200 p-1 rounded-lg">
                                            <button onClick={() => setMode('study')} className={`flex-1 py-2 rounded-md text-sm font-bold transition flex justify-center items-center gap-2 ${mode === 'study' ? 'bg-white shadow text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>
                                                <BookOpen className="w-4 h-4" /> æ§‹é€ ç†è§£
                                            </button>
                                            <button onClick={() => setMode('composition')} className={`flex-1 py-2 rounded-md text-sm font-bold transition flex justify-center items-center gap-2 ${mode === 'composition' ? 'bg-white shadow text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>
                                                <PenTool className="w-4 h-4" /> ç¬é–“è‹±ä½œæ–‡
                                            </button>
                                        </div>

                                        {/* --- ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */}
                                        {mode === 'study' ? (
                                            <div className="space-y-6 animate-fadeIn">
                                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                                    <div className="flex flex-wrap gap-2">
                                                        {currentSentence.chunks.map((chunk, idx) => (
                                                            <div key={idx} className="group relative cursor-pointer" onClick={() => speakText(chunk.text)}>
                                                                <span className={`inline-block px-2 py-1 rounded border-b-2 text-lg font-medium transition-all hover:opacity-80 ${TYPE_COLORS[chunk.type] || "bg-gray-100"}`}>{chunk.text}</span>
                                                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none z-20 shadow-lg"><p className="font-bold text-center">{chunk.label}</p><p className="text-gray-300 text-center">{chunk.japanese}</p></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 relative min-h-[5rem]">
                                                    <h3 className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-2">Meaning</h3>
                                                    {showMeaning ? (
                                                        <div className="animate-fadeIn relative pr-8">
                                                            <p className="text-gray-700 font-medium">{currentSentence.translation}</p>
                                                            <button onClick={() => setShowMeaning(false)} className="absolute top-0 right-[-0.5rem] p-1 text-indigo-300 hover:text-indigo-500 transition" title="éš ã™"><EyeOff className="w-4 h-4" /></button>
                                                        </div>
                                                    ) : (
                                                        <button onClick={() => setShowMeaning(true)} className="w-full py-2 bg-white/60 border border-indigo-200 border-dashed rounded text-indigo-500 text-sm font-bold hover:bg-white transition flex items-center justify-center gap-2"><Eye className="w-4 h-4" /> Translation</button>
                                                    )}
                                                </div>

                                                <div className="space-y-3">
                                                    <button onClick={isNativePlaying ? stopNativeAudio : playNativeAudio} disabled={nativeAudioError} className={`w-full flex items-center justify-center p-4 rounded-xl border-2 transition gap-3 ${nativeAudioError ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed' : isNativePlaying ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-slate-800 border-slate-800 text-white shadow-md hover:bg-slate-700'}`}>
                                                        {isNativePlaying ? <Pause className="w-6 h-6" /> : <Music className="w-6 h-6" />}
                                                        <div className="text-left"><span className="block text-sm font-bold">Native Audio</span><span className="block text-xs opacity-80">{nativeAudioError ? "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãªã—" : "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿ"}</span></div>
                                                    </button>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <button onClick={() => isPlaying ? cancelSpeech() : speakText(currentSentence.text)} className={`flex flex-col items-center justify-center p-3 rounded-xl border-2 transition ${isPlaying ? 'border-indigo-400 bg-indigo-50 text-indigo-600' : 'border-indigo-100 bg-white hover:bg-indigo-50 text-indigo-600'}`}><span className="text-sm font-bold">TTS å…¨æ–‡</span></button>
                                                        <button onClick={speakChunksWithPause} className="flex flex-col items-center justify-center p-3 rounded-xl border-2 border-teal-100 bg-white hover:bg-teal-50 text-teal-600 transition"><span className="text-sm font-bold">TTS åŒºåˆ‡ã‚Š</span></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            /* --- ç¬é–“è‹±ä½œæ–‡ãƒ¢ãƒ¼ãƒ‰ --- */
                                            <div className="animate-fadeIn pb-20">
                                                <div className="bg-white rounded-3xl shadow-lg border border-gray-200 overflow-hidden">
                                                    {/* æ—¥æœ¬èªã‚¨ãƒªã‚¢ */}
                                                    <div className="p-8 pb-4 text-center">
                                                        <div className="inline-block px-3 py-1 bg-gray-100 rounded-full text-[10px] font-bold text-gray-400 mb-4 tracking-wider">JAPANESE</div>
                                                        <h2 className="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
                                                            {currentSentence.translation}
                                                        </h2>
                                                    </div>

                                                    <div className="flex justify-center -mb-5 relative z-10">
                                                        <div className="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center border border-gray-200">
                                                            <div className="w-1 h-4 bg-gray-300 rounded-full"></div>
                                                        </div>
                                                    </div>

                                                    {/* è‹±èªã‚¨ãƒªã‚¢ */}
                                                    <div className={`p-8 pt-10 text-center transition-colors duration-500 ${showCompositionAnswer ? 'bg-indigo-50' : 'bg-gray-50'}`}>
                                                        {!showCompositionAnswer ? (
                                                            <div className="py-8">
                                                                {/* Timer Display when thinking */}
                                                                <div className="mb-4 flex justify-center">
                                                                    <div className="inline-flex items-center gap-2 px-4 py-1.5 bg-indigo-100 text-indigo-700 rounded-full font-mono text-lg font-bold shadow-sm">
                                                                        <Clock className="w-5 h-5" />
                                                                        {timer.toFixed(1)}s
                                                                    </div>
                                                                </div>

                                                                <button 
                                                                    onClick={handleShowAnswer}
                                                                    className="w-full max-w-xs mx-auto py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:scale-105 transition transform active:scale-95 flex items-center justify-center gap-2"
                                                                >
                                                                    <Eye className="w-5 h-5" /> ç­”ãˆã‚’è¦‹ã‚‹
                                                                </button>
                                                                <p className="text-xs text-gray-400 mt-4">ç­”ãˆã‚’è¦‹ã‚‹ã¨è‡ªå‹•ã§éŸ³å£°ãŒæµã‚Œã¾ã™</p>
                                                            </div>
                                                        ) : (
                                                            <div className="animate-slideUp space-y-6">
                                                                <div>
                                                                    <div className="flex justify-center items-center gap-2 mb-4">
                                                                        <div className="inline-block px-3 py-1 bg-indigo-100 rounded-full text-[10px] font-bold text-indigo-500 tracking-wider">ENGLISH</div>
                                                                        {/* Final Time Display */}
                                                                        <div className="inline-flex items-center gap-1 px-2 py-0.5 bg-gray-200 text-gray-600 rounded text-xs font-mono font-bold">
                                                                            <Clock className="w-3 h-3" /> {timer.toFixed(1)}s
                                                                        </div>
                                                                    </div>
                                                                    <p className="text-xl md:text-2xl font-bold text-indigo-900 leading-relaxed mb-4">{currentSentence.text}</p>
                                                                    <div className="flex flex-wrap justify-center gap-1 opacity-70 scale-90">
                                                                        {currentSentence.chunks.map((c, i) => (
                                                                            <span key={i} className="text-[10px] px-1 bg-white border rounded text-gray-500">{c.text}</span>
                                                                        ))}
                                                                    </div>
                                                                </div>

                                                                {/* éŸ³å£°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (å·¦å³åˆ†å‰²) */}
                                                                <div className="flex gap-3">
                                                                    {/* Native (å·¦) */}
                                                                    <button 
                                                                        onClick={isNativePlaying ? stopNativeAudio : playNativeAudio} 
                                                                        disabled={nativeAudioError} 
                                                                        className={`flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-xl border-2 transition shadow-sm ${nativeAudioError ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : isNativePlaying ? 'bg-pink-100 text-pink-600 border-pink-200' : 'bg-white text-pink-600 border-pink-100 hover:bg-pink-50'}`}
                                                                    >
                                                                        {isNativePlaying ? <Pause className="w-5 h-5" /> : <Music className="w-5 h-5" />}
                                                                        <span className="font-bold text-sm">Native</span>
                                                                    </button>

                                                                    {/* Robot (å³) */}
                                                                    <button 
                                                                        onClick={() => isPlaying ? cancelSpeech() : speakText(currentSentence.text)} 
                                                                        className={`flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-xl border-2 transition shadow-sm ${isPlaying ? 'bg-indigo-100 text-indigo-600 border-indigo-200' : 'bg-white text-indigo-600 border-indigo-100 hover:bg-indigo-50'}`}
                                                                    >
                                                                        {isPlaying ? <Pause className="w-5 h-5" /> : <Robot className="w-5 h-5" />}
                                                                        <span className="font-bold text-sm">Robot</span>
                                                                    </button>
                                                                </div>

                                                                <hr className="border-indigo-200 opacity-50" />

                                                                <button 
                                                                    onClick={() => { setCurrentIndex(prev => Math.min(sentences.length - 1, prev + 1)); }}
                                                                    disabled={currentIndex === sentences.length - 1}
                                                                    className="w-full py-4 bg-gray-800 text-white rounded-xl font-bold shadow-lg hover:bg-gray-700 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                                                >
                                                                    æ¬¡ã®å•é¡Œã¸ <ChevronRight className="w-5 h-5" />
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnglishChunkMaster />);
    </script>
</body>
</html>