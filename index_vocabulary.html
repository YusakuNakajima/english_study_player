<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Chunk Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- „Ç¢„Ç§„Ç≥„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
        const IconBase = ({ children, className }) => <span className={`inline-flex items-center justify-center ${className}`}>{children}</span>;
        const Play = ({ className }) => <IconBase className={className}>‚ñ∂</IconBase>;
        const Pause = ({ className }) => <IconBase className={className}>‚è∏</IconBase>;
        const BookOpen = ({ className }) => <IconBase className={className}>üìñ</IconBase>;
        const Info = ({ className }) => <IconBase className={className}>‚ÑπÔ∏è</IconBase>;
        const Settings = ({ className }) => <IconBase className={className}>‚öôÔ∏è</IconBase>;
        const ChevronRight = ({ className }) => <IconBase className={className}>‚Ä∫</IconBase>;
        const ChevronLeft = ({ className }) => <IconBase className={className}>‚Äπ</IconBase>;
        const Upload = ({ className }) => <IconBase className={className}>üì§</IconBase>;
        const FileText = ({ className }) => <IconBase className={className}>üìÑ</IconBase>;
        const Music = ({ className }) => <IconBase className={className}>üéµ</IconBase>;
        const X = ({ className }) => <IconBase className={className}>‚úï</IconBase>;
        const Save = ({ className }) => <IconBase className={className}>üíæ</IconBase>;
        const Trash2 = ({ className }) => <IconBase className={className}>üóë</IconBase>;
        const Loader2 = ({ className }) => <IconBase className={`${className} animate-spin`}>‚åõ</IconBase>;
        const AlertCircle = ({ className }) => <IconBase className={className}>‚ö†Ô∏è</IconBase>;
        const ListIcon = ({ className }) => <IconBase className={className}>‚ò∞</IconBase>;
        const Eye = ({ className }) => <IconBase className={className}>üëÅÔ∏è</IconBase>;
        const EyeOff = ({ className }) => <IconBase className={className}>üôà</IconBase>;
        const FilterIcon = ({ className }) => <IconBase className={className}>‚ö°</IconBase>;
        const PenTool = ({ className }) => <IconBase className={className}>‚úçÔ∏è</IconBase>;
        const Robot = ({ className }) => <IconBase className={className}>ü§ñ</IconBase>;

        // --- ÂàùÊúü„Éá„Éº„Çø„Çª„ÉÉ„Éà („Éá„É¢Áî®) ---
        const DEFAULT_SENTENCES = [
            {
                id: 1,
                level: "Basic",
                text: "My children are so absorbed in their iPads.",
                translation: "Â≠ê‰æõ„Åü„Å°„ÅØiPad„Å´Â§¢‰∏≠„Åß„Åô„ÄÇ",
                chunks: [
                    { text: "My children are", label: "Subject + Verb", type: "core", japanese: "ÁßÅ„ÅÆÂ≠ê‰æõ„Åü„Å°„ÅØÔΩû„Åß„Åô" },
                    { text: "so absorbed", label: "Adjective", type: "core", japanese: "„Å®„Å¶„ÇÇÂ§¢‰∏≠„Å™" },
                    { text: "in their iPads.", label: "Preposition", type: "modifier", japanese: "ÂΩº„Çâ„ÅÆiPad„Å´" }
                ]
            },
            {
                id: 2,
                level: "Basic",
                text: "I want to go.",
                translation: "Ë°å„Åç„Åü„ÅÑ„ÄÇ",
                chunks: [
                    { text: "I want", label: "SV", type: "core", japanese: "ÁßÅ„ÅØ„Åó„Åü„ÅÑ" },
                    { text: "to go.", label: "Infinitive", type: "modifier", japanese: "Ë°å„Åè„Åì„Å®„Çí" }
                ]
            }
        ];

        // Ëâ≤ÂàÜ„ÅëË®≠ÂÆö
        const TYPE_COLORS = {
            core: "bg-red-100 text-red-800 border-red-200",
            modifier: "bg-green-100 text-green-800 border-green-200",
            connector: "bg-blue-100 text-blue-800 border-blue-200"
        };

        function EnglishChunkMaster() {
            // --- State ---
            const [allSentences, setAllSentences] = useState(DEFAULT_SENTENCES);
            const [sentences, setSentences] = useState(DEFAULT_SENTENCES);
            const [minChunkCount, setMinChunkCount] = useState(1);

            const [isLoading, setIsLoading] = useState(true);
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [mode, setMode] = useState('study'); // 'study' | 'composition' | 'settings'
            const [isPlaying, setIsPlaying] = useState(false);
            const [isNativePlaying, setIsNativePlaying] = useState(false);
            const [nativeAudioError, setNativeAudioError] = useState(false);
            
            const [showMeaning, setShowMeaning] = useState(false); // Study„É¢„Éº„ÉâÁî®
            const [showCompositionAnswer, setShowCompositionAnswer] = useState(false); // Composition„É¢„Éº„ÉâÁî®

            const [audioMap, setAudioMap] = useState({});
            const audioPlayerRef = useRef(null);
            const [csvInput, setCsvInput] = useState("");
            const [importError, setImportError] = useState(null);
            const [jumpIdInput, setJumpIdInput] = useState("");

            const currentSentence = sentences[currentIndex] || null;
            const synthesisRef = useRef(window.speechSynthesis);

            const nativeAudioSrc = currentSentence ? (audioMap[currentSentence.id] || `./audio/${currentSentence.id}.mp3`) : "";

            // --- Effects ---
            
            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Âá¶ÁêÜ
            useEffect(() => {
                const filtered = allSentences.filter(s => s.chunks.length >= minChunkCount);
                setSentences(filtered);
                setCurrentIndex(0);
            }, [minChunkCount, allSentences]);

            useEffect(() => {
                const autoLoadData = async () => {
                    try {
                        setIsLoading(true);
                        const response = await fetch('vocabulary_data.csv');
                        if (!response.ok) throw new Error("vocabulary_data.csv not found");
                        const text = await response.text();
                        if (!text.trim()) throw new Error("Empty CSV");
                        const loaded = parseCSV(text, true);
                        if (loaded) {
                            setIsDataLoaded(true);
                        }
                    } catch (error) {
                        console.log("Auto-load failed. Using demo mode.");
                        setIsDataLoaded(false);
                    } finally {
                        setIsLoading(false);
                    }
                };
                autoLoadData();
            }, []);

            useEffect(() => {
                return () => {
                    cancelSpeech();
                    Object.values(audioMap).forEach(url => URL.revokeObjectURL(url));
                };
            }, []);

            // „Éö„Éº„Ç∏„ÇÑ„É¢„Éº„Éâ„ÅåÂ§â„Çè„Å£„Åü„Å®„Åç„ÅÆ„É™„Çª„ÉÉ„ÉàÂá¶ÁêÜ
            useEffect(() => {
                cancelSpeech();
                stopNativeAudio();
                setNativeAudioError(false);
                setShowMeaning(false);
                setShowCompositionAnswer(false);
            }, [currentIndex, mode, sentences]);

            // --- Functions ---
            
            // NativeÈü≥Â£∞ÂÜçÁîü
            const playNativeAudio = () => {
                cancelSpeech();
                if (audioPlayerRef.current && nativeAudioSrc && !nativeAudioError) {
                    return audioPlayerRef.current.play()
                        .then(() => { setIsNativePlaying(true); return true; })
                        .catch(e => { 
                            console.error("Audio playback error:", e); 
                            setNativeAudioError(true); 
                            return false; 
                        });
                }
                return Promise.resolve(false);
            };

            const stopNativeAudio = () => {
                if (audioPlayerRef.current) { audioPlayerRef.current.pause(); audioPlayerRef.current.currentTime = 0; }
                setIsNativePlaying(false);
            };

            // RobotÈü≥Â£∞ÂÜçÁîü (TTS)
            const speakText = (text, rate = 1.0, onEnd = () => {}) => {
                stopNativeAudio();
                cancelSpeech();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rate;
                utterance.onend = () => { setIsPlaying(false); onEnd(); };
                utterance.onerror = () => setIsPlaying(false);
                setIsPlaying(true);
                synthesisRef.current.speak(utterance);
            };

            // „ÄåÁ≠î„Åà„ÇíË¶ã„Çã„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Åü„Å®„Åç„ÅÆÂá¶ÁêÜÔºàËá™ÂãïÂÜçÁîü„É≠„Ç∏„ÉÉ„ÇØÔºâ
            const handleShowAnswer = async () => {
                setShowCompositionAnswer(true);
                
                // NativeÈü≥Â£∞„ÅÆÂÜçÁîü„ÇíË©¶„Åø„Çã
                if (nativeAudioSrc && !nativeAudioError) {
                    const success = await playNativeAudio();
                    if (!success) {
                        // NativeÂÜçÁîü„Å´Â§±Êïó„Åó„Åü„ÇâRobotÈü≥Â£∞„ÇíÊµÅ„Åô
                        console.log("Fallback to Robot Voice");
                        speakText(currentSentence.text);
                    }
                } else {
                    // NativeÈü≥Â£∞„ÇΩ„Éº„Çπ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊúÄÂàù„Åã„ÇâRobotÈü≥Â£∞„ÇíÊµÅ„Åô
                    speakText(currentSentence.text);
                }
            };

            const handleJumpToId = () => {
                const idToJump = parseInt(jumpIdInput, 10);
                if (isNaN(idToJump)) return;
                const targetIndex = sentences.findIndex(s => s.id === idToJump);
                if (targetIndex !== -1) {
                    setCurrentIndex(targetIndex);
                } else {
                    alert(`ID ${idToJump} „ÅÆÂïèÈ°å„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ`);
                }
                setJumpIdInput("");
            };

            const handleJumpInputKeyDown = (e) => {
                if (e.key === 'Enter') handleJumpToId();
            };
            
            const parseCSV = (text, isAutoLoad = false) => {
                try {
                    const lines = text.trim().split('\n');
                    const newSentences = lines.map((line, index) => {
                        const cleanLine = line.trim().replace(/^\uFEFF/, '');
                        if (index === 0 && (cleanLine.toLowerCase().startsWith('id') || cleanLine.includes('Ëã±Êñá'))) return null;
                        const parts = line.split('|').map(p => p.trim());
                        if (parts.length < 3) return null;
                        let idVal = parseInt(parts[0], 10);
                        let startIndex = 1;
                        if (isNaN(idVal)) { idVal = Date.now() + index; startIndex = 0; }
                        const sentenceText = parts[startIndex];
                        const translation = parts[startIndex + 1];
                        const chunkRawData = parts.slice(startIndex + 2);
                        const chunks = chunkRawData.map(chunkStr => {
                            const [cText, cLabel, cType, cJp] = chunkStr.split('^').map(s => s?.trim());
                            return { text: cText || "", label: cLabel || "", type: (cType === 'core' || cType === 'modifier' || cType === 'connector') ? cType : 'core', japanese: cJp || "" };
                        }).filter(c => c.text);
                        return { id: idVal, level: "Custom", text: sentenceText, translation: translation, chunks: chunks };
                    }).filter(Boolean);
                    if (newSentences.length === 0) throw new Error("ÊúâÂäπ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
                    setAllSentences(newSentences);
                    setMode('study');
                    setImportError(null);
                    if (!isAutoLoad) alert(`${newSentences.length} ‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ`);
                    return true;
                } catch (e) {
                    setImportError(e.message);
                    if (!isAutoLoad) alert(e.message);
                    return false;
                }
            };

            const handleAudioUpload = (e) => {
                const files = Array.from(e.target.files);
                const newAudioMap = { ...audioMap };
                let count = 0;
                files.forEach(file => {
                    const match = file.name.match(/\((\d+)\)/) || file.name.match(/(\d+)/);
                    if (match) {
                        const id = parseInt(match[1], 10);
                        if (newAudioMap[id]) URL.revokeObjectURL(newAudioMap[id]);
                        newAudioMap[id] = URL.createObjectURL(file);
                        count++;
                    }
                });
                setAudioMap(newAudioMap);
                alert(`${count} ÂÄã„ÅÆÈü≥Â£∞„Éï„Ç°„Ç§„É´„Çí„É™„É≥„ÇØ„Åó„Åæ„Åó„ÅüÔºÅ`);
            };

            const clearAudioData = () => {
                Object.values(audioMap).forEach(url => URL.revokeObjectURL(url));
                setAudioMap({});
            };

            const cancelSpeech = () => {
                if (synthesisRef.current) { synthesisRef.current.cancel(); setIsPlaying(false); }
            };

            const speakChunksWithPause = async () => {
                if (!currentSentence) return;
                stopNativeAudio();
                cancelSpeech();
                setIsPlaying(true);
                const speakChunk = (index) => {
                    if (index >= currentSentence.chunks.length) { setIsPlaying(false); return; }
                    const chunk = currentSentence.chunks[index];
                    const utterance = new SpeechSynthesisUtterance(chunk.text);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.9;
                    utterance.onend = () => { setTimeout(() => speakChunk(index + 1), 800); };
                    synthesisRef.current.speak(utterance);
                };
                speakChunk(0);
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 text-gray-500">
                        <div className="flex flex-col items-center gap-2">
                            <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
                            <p className="text-sm font-medium">Loading data...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-20">
                    <audio ref={audioPlayerRef} src={nativeAudioSrc} onEnded={()=> setIsNativePlaying(false)} onError={() => { setIsNativePlaying(false); setNativeAudioError(true); }} />

                    <header className="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-20">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <h1 className="text-lg font-bold flex items-center gap-2">
                                <Settings className="w-5 h-5 text-indigo-400" />
                                English Chunk Master
                            </h1>
                            <div className="flex items-center gap-2">
                                {isDataLoaded ? <span className="text-[10px] bg-green-600 px-2 py-0.5 rounded-full font-bold">CSVË™≠ËæºÊ∏à</span> : <span className="text-[10px] bg-gray-600 px-2 py-0.5 rounded-full font-bold">„Éá„É¢„É¢„Éº„Éâ</span>}
                                <button onClick={()=> setMode(mode === 'settings' ? 'study' : 'settings')} className={`p-2 rounded-full transition ${mode === 'settings' ? 'bg-slate-600' : 'hover:bg-slate-700'}`}>
                                    {mode === 'settings' ? <X className="w-5 h-5" /> : <Settings className="w-5 h-5" />}
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-4">
                        {!isDataLoaded && mode !== 'settings' && (
                            <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 text-xs p-3 rounded-lg flex items-start gap-2 animate-fadeIn">
                                <AlertCircle className="w-4 h-4 shrink-0 mt-0.5" />
                                <div><p className="font-bold">„Éá„É¢„É¢„Éº„Éâ„ÅßÂãï‰Ωú‰∏≠</p><p>vocabulary_data.csv„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p></div>
                            </div>
                        )}

                        {mode === 'settings' ? (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Ë®≠ÂÆöÁîªÈù¢ */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><FileText className="w-5 h-5 text-indigo-600" />„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø</h2>
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-6 text-sm text-blue-800">
                                        <p className="font-bold flex items-center gap-2 mb-1"><Info className="w-4 h-4" />Ëá™ÂãïË™≠„ÅøËæº„Åø„Å´„Å§„ÅÑ„Å¶</p>
                                        <p className="text-xs leading-relaxed opacity-90">„Ç¢„Éó„É™„Å®Âêå„ÅòÂ†¥ÊâÄ„Å´ <code>vocabulary_data.csv</code> „ÇíÁΩÆ„Åè„Å®Ëá™Âãï„ÅßË™≠„ÅøËæº„Åæ„Çå„Åæ„Åô„ÄÇ<br />Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅØ <code>1.mp3</code> „ÅÆ„Çà„ÅÜ„Å´ID„Å´ÂØæÂøú„Åô„Çã„Éï„Ç°„Ç§„É´Âêç„ÅßÁΩÆ„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                                    </div>
                                    <div className="mb-6">
                                        <label className="block text-sm font-bold text-gray-700 mb-2">ÊâãÂãï„ÅßCSV„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë</label>
                                        <textarea className="w-full h-32 p-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono" placeholder="„Åì„Åì„Å´„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ..." value={csvInput} onChange={(e)=> setCsvInput(e.target.value)} />
                                        {importError && <p className="text-red-500 text-xs mt-2">{importError}</p>}
                                        <button onClick={() => parseCSV(csvInput)} className="mt-3 w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2"><Save className="w-4 h-4" />CSV„ÇíÂèçÊò†„Åô„Çã</button>
                                    </div>
                                    <div className="border-t pt-6">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="text-sm font-bold text-gray-700 flex items-center gap-2"><Music className="w-4 h-4 text-pink-500" />ÊâãÂãï„ÅßÈü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</h3>
                                            {Object.keys(audioMap).length > 0 && <button onClick={clearAudioData} className="text-xs text-red-500 flex items-center gap-1"><Trash2 className="w-3 h-3" /> „ÇØ„É™„Ç¢</button>}
                                        </div>
                                        <label className="block w-full cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 py-4 px-4 rounded-lg border-2 border-dashed border-gray-300 text-center transition">
                                            <span className="flex items-center justify-center gap-2 text-sm"><Upload className="w-4 h-4" /> „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû (Ë§áÊï∞ÈÅ∏ÊäûOK)</span>
                                            <input type="file" accept="audio/*" multiple className="hidden" onChange={handleAudioUpload} />
                                        </label>
                                        {Object.keys(audioMap).length > 0 && <div className="mt-3 text-xs text-green-600 font-bold text-center">{Object.keys(audioMap).length} ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„Åå„É™„É≥„ÇØÊ∏à„Åø</div>}
                                    </div>
                                </div>
                                <button onClick={() => { setAllSentences(DEFAULT_SENTENCES); setAudioMap({}); setIsDataLoaded(false); }} className="w-full py-3 text-sm text-gray-500 hover:text-red-500 transition">„Éá„É¢„Éá„Éº„Çø„Å´Êàª„Åô</button>
                            </div>
                        ) : (
                            <>
                                {/* --- „Éï„Ç£„É´„Çø„Éº & „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ --- */}
                                <div className="bg-white px-4 py-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                                    <div className="flex items-center gap-1 text-indigo-600 min-w-fit">
                                        <FilterIcon className="w-4 h-4" />
                                        <span className="text-[10px] font-bold uppercase tracking-wider">Chunk Filter</span>
                                    </div>
                                    <div className="flex-1 flex flex-col justify-center">
                                        <div className="flex justify-between items-end mb-1">
                                            <span className="text-xs font-bold text-gray-500">Min: {minChunkCount}</span>
                                            <span className="text-[10px] font-mono text-gray-400">{sentences.length}/{allSentences.length} items</span>
                                        </div>
                                        <input type="range" min="1" max="10" value={minChunkCount} onChange={(e) => setMinChunkCount(Number(e.target.value))} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                    </div>
                                </div>

                                {sentences.length === 0 ? (
                                    <div className="text-center py-20 text-gray-500 animate-fadeIn">
                                        <p className="text-lg font-bold mb-2">Ë°®Á§∫„Åß„Åç„ÇãÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                        <p className="text-sm mb-4">‰∏ä„ÅÆ„Çπ„É©„Ç§„ÉÄ„Éº„ÅßÊù°‰ª∂„ÇíÁ∑©Âíå„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm gap-2">
                                            <button onClick={() => setCurrentIndex(prev => Math.max(0, prev - 1))} disabled={currentIndex === 0} className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30 transition flex-shrink-0"><ChevronLeft className="w-6 h-6 text-indigo-600" /></button>
                                            <div className="flex-1 flex items-center gap-2 min-w-0">
                                                <div className="flex-1 min-w-0 bg-gray-100 rounded-lg relative">
                                                    <select value={currentIndex} onChange={(e) => setCurrentIndex(Number(e.target.value))} className="w-full h-full bg-transparent p-2 text-sm text-gray-700 font-bold appearance-none outline-none truncate pr-8 z-10 relative cursor-pointer">
                                                        {sentences.map((sentence, idx) => (
                                                            <option key={sentence.id} value={idx}>
                                                                {idx + 1}. [ID:{sentence.id}] {sentence.text.slice(0, 20)}{sentence.text.length > 20 ? '...' : ''} ({sentence.chunks.length} chunks)
                                                            </option>
                                                        ))}
                                                    </select>
                                                    <div className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"><ListIcon className="w-4 h-4" /></div>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <input type="number" value={jumpIdInput} onChange={(e) => setJumpIdInput(e.target.value)} onKeyDown={handleJumpInputKeyDown} className="w-20 p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ID Jump" />
                                                    <button onClick={handleJumpToId} className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-bold">Go</button>
                                                </div>
                                            </div>
                                            <button onClick={() => setCurrentIndex(prev => Math.min(sentences.length - 1, prev + 1))} disabled={currentIndex === sentences.length - 1} className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30 transition flex-shrink-0"><ChevronRight className="w-6 h-6 text-indigo-600" /></button>
                                        </div>

                                        {/* --- „Çø„ÉñÂàá„ÇäÊõø„Åà --- */}
                                        <div className="flex bg-gray-200 p-1 rounded-lg">
                                            <button onClick={() => setMode('study')} className={`flex-1 py-2 rounded-md text-sm font-bold transition flex justify-center items-center gap-2 ${mode === 'study' ? 'bg-white shadow text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>
                                                <BookOpen className="w-4 h-4" /> ÊßãÈÄ†ÁêÜËß£
                                            </button>
                                            <button onClick={() => setMode('composition')} className={`flex-1 py-2 rounded-md text-sm font-bold transition flex justify-center items-center gap-2 ${mode === 'composition' ? 'bg-white shadow text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>
                                                <PenTool className="w-4 h-4" /> Áû¨ÈñìËã±‰ΩúÊñá
                                            </button>
                                        </div>

                                        {/* --- „É¢„Éº„ÉâÂà•„Ç≥„É≥„ÉÜ„É≥„ÉÑ --- */}
                                        {mode === 'study' ? (
                                            <div className="space-y-6 animate-fadeIn">
                                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                                    <div className="flex flex-wrap gap-2 mb-4">
                                                        {currentSentence.chunks.map((chunk, idx) => (
                                                            <div key={idx} className="group relative cursor-pointer" onClick={() => speakText(chunk.text)}>
                                                                <span className={`inline-block px-2 py-1 rounded border-b-2 text-lg font-medium transition-all hover:opacity-80 ${TYPE_COLORS[chunk.type] || "bg-gray-100"}`}>{chunk.text}</span>
                                                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none z-20 shadow-lg"><p className="font-bold text-center">{chunk.label}</p><p className="text-gray-300 text-center">{chunk.japanese}</p></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <p className="text-gray-500 text-sm mt-4 border-t pt-3 flex items-center gap-2"><Info className="w-4 h-4" />„Éñ„É≠„ÉÉ„ÇØ„Çí„Çø„ÉÉ„Éó„ÅßÁô∫Èü≥ (TTS)</p>
                                                </div>

                                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 relative min-h-[5rem]">
                                                    <h3 className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-2">Meaning</h3>
                                                    {showMeaning ? (
                                                        <div className="animate-fadeIn relative pr-8">
                                                            <p className="text-gray-700 font-medium">{currentSentence.translation}</p>
                                                            <button onClick={() => setShowMeaning(false)} className="absolute top-0 right-[-0.5rem] p-1 text-indigo-300 hover:text-indigo-500 transition" title="Èö†„Åô"><EyeOff className="w-4 h-4" /></button>
                                                        </div>
                                                    ) : (
                                                        <button onClick={() => setShowMeaning(true)} className="w-full py-2 bg-white/60 border border-indigo-200 border-dashed rounded text-indigo-500 text-sm font-bold hover:bg-white transition flex items-center justify-center gap-2"><Eye className="w-4 h-4" /> Translation</button>
                                                    )}
                                                </div>

                                                <div className="space-y-3">
                                                    <button onClick={isNativePlaying ? stopNativeAudio : playNativeAudio} disabled={nativeAudioError} className={`w-full flex items-center justify-center p-4 rounded-xl border-2 transition gap-3 ${nativeAudioError ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed' : isNativePlaying ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-slate-800 border-slate-800 text-white shadow-md hover:bg-slate-700'}`}>
                                                        {isNativePlaying ? <Pause className="w-6 h-6" /> : <Music className="w-6 h-6" />}
                                                        <div className="text-left"><span className="block text-sm font-bold">Native Audio</span><span className="block text-xs opacity-80">{nativeAudioError ? "Èü≥Â£∞„Éï„Ç°„Ç§„É´„Å™„Åó" : "Èü≥Â£∞„Éï„Ç°„Ç§„É´ÂÜçÁîü"}</span></div>
                                                    </button>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <button onClick={() => isPlaying ? cancelSpeech() : speakText(currentSentence.text)} className={`flex flex-col items-center justify-center p-3 rounded-xl border-2 transition ${isPlaying ? 'border-indigo-400 bg-indigo-50 text-indigo-600' : 'border-indigo-100 bg-white hover:bg-indigo-50 text-indigo-600'}`}><span className="text-sm font-bold">TTS ÂÖ®Êñá</span></button>
                                                        <button onClick={speakChunksWithPause} className="flex flex-col items-center justify-center p-3 rounded-xl border-2 border-teal-100 bg-white hover:bg-teal-50 text-teal-600 transition"><span className="text-sm font-bold">TTS Âå∫Âàá„Çä</span></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            /* --- Áû¨ÈñìËã±‰ΩúÊñá„É¢„Éº„Éâ --- */
                                            <div className="animate-fadeIn pb-20">
                                                <div className="bg-white rounded-3xl shadow-lg border border-gray-200 overflow-hidden">
                                                    {/* Êó•Êú¨Ë™û„Ç®„É™„Ç¢ */}
                                                    <div className="p-8 pb-4 text-center">
                                                        <div className="inline-block px-3 py-1 bg-gray-100 rounded-full text-[10px] font-bold text-gray-400 mb-4 tracking-wider">JAPANESE</div>
                                                        <h2 className="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
                                                            {currentSentence.translation}
                                                        </h2>
                                                    </div>

                                                    <div className="flex justify-center -mb-5 relative z-10">
                                                        <div className="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center border border-gray-200">
                                                            <div className="w-1 h-4 bg-gray-300 rounded-full"></div>
                                                        </div>
                                                    </div>

                                                    {/* Ëã±Ë™û„Ç®„É™„Ç¢ */}
                                                    <div className={`p-8 pt-10 text-center transition-colors duration-500 ${showCompositionAnswer ? 'bg-indigo-50' : 'bg-gray-50'}`}>
                                                        {!showCompositionAnswer ? (
                                                            <div className="py-8">
                                                                <button 
                                                                    onClick={handleShowAnswer}
                                                                    className="w-full max-w-xs mx-auto py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:scale-105 transition transform active:scale-95 flex items-center justify-center gap-2"
                                                                >
                                                                    <Eye className="w-5 h-5" /> Á≠î„Åà„ÇíË¶ã„Çã
                                                                </button>
                                                                <p className="text-xs text-gray-400 mt-4">Á≠î„Åà„ÇíË¶ã„Çã„Å®Ëá™Âãï„ÅßÈü≥Â£∞„ÅåÊµÅ„Çå„Åæ„Åô</p>
                                                            </div>
                                                        ) : (
                                                            <div className="animate-slideUp space-y-6">
                                                                <div>
                                                                    <div className="inline-block px-3 py-1 bg-indigo-100 rounded-full text-[10px] font-bold text-indigo-500 mb-4 tracking-wider">ENGLISH</div>
                                                                    <p className="text-xl md:text-2xl font-bold text-indigo-900 leading-relaxed mb-4">{currentSentence.text}</p>
                                                                    <div className="flex flex-wrap justify-center gap-1 opacity-70 scale-90">
                                                                        {currentSentence.chunks.map((c, i) => (
                                                                            <span key={i} className="text-[10px] px-1 bg-white border rounded text-gray-500">{c.text}</span>
                                                                        ))}
                                                                    </div>
                                                                </div>

                                                                {/* Èü≥Â£∞„Ç≥„É≥„Éà„É≠„Éº„É´ (Â∑¶Âè≥ÂàÜÂâ≤) */}
                                                                <div className="flex gap-3">
                                                                    {/* Native (Â∑¶) */}
                                                                    <button 
                                                                        onClick={isNativePlaying ? stopNativeAudio : playNativeAudio} 
                                                                        disabled={nativeAudioError} 
                                                                        className={`flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-xl border-2 transition shadow-sm ${nativeAudioError ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : isNativePlaying ? 'bg-pink-100 text-pink-600 border-pink-200' : 'bg-white text-pink-600 border-pink-100 hover:bg-pink-50'}`}
                                                                    >
                                                                        {isNativePlaying ? <Pause className="w-5 h-5" /> : <Music className="w-5 h-5" />}
                                                                        <span className="font-bold text-sm">Native</span>
                                                                    </button>

                                                                    {/* Robot (Âè≥) */}
                                                                    <button 
                                                                        onClick={() => isPlaying ? cancelSpeech() : speakText(currentSentence.text)} 
                                                                        className={`flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-xl border-2 transition shadow-sm ${isPlaying ? 'bg-indigo-100 text-indigo-600 border-indigo-200' : 'bg-white text-indigo-600 border-indigo-100 hover:bg-indigo-50'}`}
                                                                    >
                                                                        {isPlaying ? <Pause className="w-5 h-5" /> : <Robot className="w-5 h-5" />}
                                                                        <span className="font-bold text-sm">Robot</span>
                                                                    </button>
                                                                </div>

                                                                <hr className="border-indigo-200 opacity-50" />

                                                                <button 
                                                                    onClick={() => { setCurrentIndex(prev => Math.min(sentences.length - 1, prev + 1)); }}
                                                                    disabled={currentIndex === sentences.length - 1}
                                                                    className="w-full py-4 bg-gray-800 text-white rounded-xl font-bold shadow-lg hover:bg-gray-700 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                                                >
                                                                    Ê¨°„ÅÆÂïèÈ°å„Å∏ <ChevronRight className="w-5 h-5" />
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnglishChunkMaster />);
    </script>
</body>
</html>