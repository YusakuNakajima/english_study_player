import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, Check, ArrowRight, BookOpen, Ear, Info, Volume2, Settings, ChevronRight, ChevronLeft,
Upload, FileText, Music, X, Save, Trash2, Loader2, AlertCircle } from 'lucide-react';

// --- 初期データセット (デモ用) ---
const DEFAULT_SENTENCES = [
{
id: 1,
level: "Basic",
text: "My children are so absorbed in their iPads.",
translation: "子供たちはiPadに夢中です。",
chunks: [
{ text: "My children are", label: "Subject + Verb", type: "core", japanese: "私の子供たちは～です" },
{ text: "so absorbed", label: "Adjective", type: "core", japanese: "とても夢中な" },
{ text: "in their iPads.", label: "Preposition", type: "modifier", japanese: "彼らのiPadに" }
]
}
];

// 色分け設定
const TYPE_COLORS = {
core: "bg-red-100 text-red-800 border-red-200",
modifier: "bg-green-100 text-green-800 border-green-200",
connector: "bg-blue-100 text-blue-800 border-blue-200"
};

export default function EnglishChunkMaster() {
// --- State ---
const [sentences, setSentences] = useState(DEFAULT_SENTENCES);
const [isLoading, setIsLoading] = useState(true); // 初期読み込み中フラグ
const [isDataLoaded, setIsDataLoaded] = useState(false); // 外部データ読み込み成功フラグ

const [currentIndex, setCurrentIndex] = useState(0);
const [mode, setMode] = useState('study'); // 'study' | 'quiz' | 'settings'
const [isPlaying, setIsPlaying] = useState(false);
const [playbackRate, setPlaybackRate] = useState(1.0);
const [isNativePlaying, setIsNativePlaying] = useState(false);
const [nativeAudioError, setNativeAudioError] = useState(false); // 音声ファイル不在エラー

// カスタム音声ファイル用: { id: "blob:url..." } のマップ形式 (手動アップロード用)
const [audioMap, setAudioMap] = useState({});
const audioPlayerRef = useRef(null);

// CSV入力用
const [csvInput, setCsvInput] = useState("");
const [importError, setImportError] = useState(null);

// クイズ用State
const [shuffledChunks, setShuffledChunks] = useState([]);
const [selectedChunks, setSelectedChunks] = useState([]);
const [quizResult, setQuizResult] = useState(null);

const currentSentence = sentences[currentIndex] || sentences[0];
const synthesisRef = useRef(window.speechSynthesis);

// 音声ソースの決定: 手動アップロードがあればそれ、なければ直下のファイル(ID.mp3)を参照
// data.csvと同じ場所に {id}.mp3 があると仮定
const nativeAudioSrc = audioMap[currentSentence.id] || `${currentSentence.id}.mp3`;

// --- Effects ---

// 1. 初回起動時に data.csv を探しに行く
useEffect(() => {
const autoLoadData = async () => {
try {
setIsLoading(true);
// 直下の data.csv を取得
const response = await fetch('data.csv');

if (!response.ok) {
throw new Error("data.csv not found");
}

const text = await response.text();
if (!text.trim()) throw new Error("Empty CSV");

// CSVパース実行（成功すれば sentences が更新される）
const loaded = parseCSV(text, true);

if (loaded) {
setIsDataLoaded(true);
console.log("Auto-loaded data.csv successfully.");
}
} catch (error) {
console.log("Auto-load failed or no data.csv found. Using demo mode.", error);
// 失敗時はデフォルトデータのまま (デモモード)
setIsDataLoaded(false);
} finally {
setIsLoading(false);
}
};

autoLoadData();
}, []); // 初回のみ

useEffect(() => {
return () => {
cancelSpeech();
// メモリ解放
Object.values(audioMap).forEach(url => URL.revokeObjectURL(url));
};
}, []);

useEffect(() => {
resetQuiz();
cancelSpeech();
stopNativeAudio();
// 文が変わるたびに音声エラー状態をリセットして再チェックできるようにする
setNativeAudioError(false);
}, [currentIndex, mode, sentences]);

// --- CSV Parser ---
// isAutoLoad: 自動読み込み時はAlertを出さないようにする制御用
const parseCSV = (text, isAutoLoad = false) => {
try {
const lines = text.trim().split('\n');
const newSentences = lines.map((line, index) => {
// ヘッダー行 (ID | ...) をスキップ
// BOM (\uFEFF) を除去してから判定
const cleanLine = line.trim().replace(/^\uFEFF/, '');
if (index === 0 && (cleanLine.toLowerCase().startsWith('id') || cleanLine.includes('英文'))) {
return null;
}

const parts = line.split('|').map(p => p.trim());
if (parts.length < 3) return null; // IDが含まれているか判定 let idVal=parseInt(parts[0], 10); let startIndex=1; if (isNaN(idVal))
  { // IDがない場合は自動採番するが、もし先頭がテキストなら旧フォーマットとして処理 idVal=Date.now() + index; startIndex=0; } const
  sentenceText=parts[startIndex]; const translation=parts[startIndex + 1]; const chunkRawData=parts.slice(startIndex +
  2); const chunks=chunkRawData.map(chunkStr=> {
  const [cText, cLabel, cType, cJp] = chunkStr.split('^').map(s => s?.trim());
  return {
  text: cText || "",
  label: cLabel || "",
  type: (cType === 'core' || cType === 'modifier' || cType === 'connector') ? cType : 'core',
  japanese: cJp || ""
  };
  }).filter(c => c.text);

  return {
  id: idVal,
  level: "Custom",
  text: sentenceText,
  translation: translation,
  chunks: chunks
  };
  }).filter(Boolean);

  if (newSentences.length === 0) throw new Error("有効なデータが見つかりませんでした。");

  setSentences(newSentences);
  setCurrentIndex(0);
  setMode('study');
  setImportError(null);

  if (!isAutoLoad) {
  alert(`${newSentences.length} 件のデータを読み込みました！`);
  }
  return true; // Success
  } catch (e) {
  setImportError(e.message);
  if (!isAutoLoad) alert(e.message);
  return false; // Failed
  }
  };

  // --- Audio File Handler (Manual Upload) ---
  const handleAudioUpload = (e) => {
  const files = Array.from(e.target.files);
  const newAudioMap = { ...audioMap };
  let count = 0;

  files.forEach(file => {
  // ファイル名から数字を抽出
  const match = file.name.match(/\((\d+)\)/) || file.name.match(/(\d+)/);
  if (match) {
  const id = parseInt(match[1], 10);
  if (newAudioMap[id]) URL.revokeObjectURL(newAudioMap[id]);
  newAudioMap[id] = URL.createObjectURL(file);
  count++;
  }
  });

  setAudioMap(newAudioMap);
  alert(`${count} 個の音声ファイルをリンクしました！`);
  };

  const clearAudioData = () => {
  Object.values(audioMap).forEach(url => URL.revokeObjectURL(url));
  setAudioMap({});
  };

  // --- Audio Playback Control ---
  const playNativeAudio = () => {
  cancelSpeech(); // TTS停止
  if (audioPlayerRef.current && nativeAudioSrc && !nativeAudioError) {
  audioPlayerRef.current.play().then(() => {
  setIsNativePlaying(true);
  }).catch(e => {
  console.error("Audio playback error:", e);
  setNativeAudioError(true); // 再生失敗＝ファイルなし等とみなす
  });
  }
  };

  const stopNativeAudio = () => {
  if (audioPlayerRef.current) {
  audioPlayerRef.current.pause();
  audioPlayerRef.current.currentTime = 0;
  }
  setIsNativePlaying(false);
  };

  // --- TTS Functions ---
  const cancelSpeech = () => {
  if (synthesisRef.current) {
  synthesisRef.current.cancel();
  setIsPlaying(false);
  }
  };

  const speakText = (text, rate = 1.0, onEnd = () => {}) => {
  stopNativeAudio();
  cancelSpeech();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'en-US';
  utterance.rate = rate;
  utterance.onend = () => {
  setIsPlaying(false);
  onEnd();
  };
  utterance.onerror = () => setIsPlaying(false);
  setIsPlaying(true);
  synthesisRef.current.speak(utterance);
  };

  const speakChunksWithPause = async () => {
  stopNativeAudio();
  cancelSpeech();
  setIsPlaying(true);

  const speakChunk = (index) => {
  if (index >= currentSentence.chunks.length) {
  setIsPlaying(false);
  return;
  }
  const chunk = currentSentence.chunks[index];
  const utterance = new SpeechSynthesisUtterance(chunk.text);
  utterance.lang = 'en-US';
  utterance.rate = playbackRate * 0.9;
  utterance.onend = () => {
  setTimeout(() => {
  speakChunk(index + 1);
  }, 800);
  };
  synthesisRef.current.speak(utterance);
  };
  speakChunk(0);
  };

  // --- Quiz Functions ---
  const resetQuiz = () => {
  if (!currentSentence) return;
  const chunksWithId = currentSentence.chunks.map((c, i) => ({ ...c, id: i }));
  const shuffled = [...chunksWithId].sort(() => Math.random() - 0.5);
  setShuffledChunks(shuffled);
  setSelectedChunks([]);
  setQuizResult(null);
  };

  const handleChunkSelect = (chunk) => {
  if (quizResult === 'correct') return;
  setShuffledChunks(prev => prev.filter(c => c.id !== chunk.id));
  setSelectedChunks(prev => [...prev, chunk]);
  };

  const handleChunkDeselect = (chunk) => {
  if (quizResult === 'correct') return;
  setSelectedChunks(prev => prev.filter(c => c.id !== chunk.id));
  setShuffledChunks(prev => [...prev, chunk]);
  };

  const checkAnswer = () => {
  const currentAnswer = selectedChunks.map(c => c.text).join(' ');
  const normalize = str => str.replace(/[.,]/g, '').trim().toLowerCase();
  const isCorrect = normalize(currentAnswer) === normalize(currentSentence.text);

  setQuizResult(isCorrect ? 'correct' : 'incorrect');
  if (isCorrect) speakText("Correct!", 1.2);
  else speakText("Try again.", 1.2);
  };

  if (isLoading) {
  return (
  <div className="min-h-screen flex items-center justify-center bg-gray-50 text-gray-500">
    <div className="flex flex-col items-center gap-2">
      <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      <p className="text-sm font-medium">Loading data...</p>
    </div>
  </div>
  );
  }

  // --- Render ---
  return (
  <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-20">

    {/* Hidden Native Audio Player Element */}
    {/* srcを変更するたびに再読み込みさせる */}
    <audio ref={audioPlayerRef} src={nativeAudioSrc} onEnded={()=> setIsNativePlaying(false)}
      onError={() => {
      setIsNativePlaying(false);
      setNativeAudioError(true); // ファイルが見つからない等のエラーを検知
      }}
      />

      {/* Header */}
      <header className="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-20">
        <div className="max-w-md mx-auto flex justify-between items-center">
          <h1 className="text-lg font-bold flex items-center gap-2">
            <Settings className="w-5 h-5 text-indigo-400" />
            English Chunk Master
          </h1>
          <div className="flex items-center gap-2">
            {isDataLoaded ? (
            <span className="text-[10px] bg-green-600 px-2 py-0.5 rounded-full font-bold">CSV読込済</span>
            ) : (
            <span className="text-[10px] bg-gray-600 px-2 py-0.5 rounded-full font-bold">デモモード</span>
            )}
            <button onClick={()=> setMode(mode === 'settings' ? 'study' : 'settings')}
              className={`p-2 rounded-full transition ${mode === 'settings' ? 'bg-slate-600' : 'hover:bg-slate-700'}`}
              >
              {mode === 'settings' ?
              <X className="w-5 h-5" /> :
              <Settings className="w-5 h-5" />}
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4 space-y-6">

        {/* デモモード時の通知 */}
        {!isDataLoaded && mode !== 'settings' && (
        <div
          className="bg-yellow-50 border border-yellow-200 text-yellow-800 text-xs p-3 rounded-lg flex items-start gap-2 animate-fadeIn">
          <AlertCircle className="w-4 h-4 shrink-0 mt-0.5" />
          <div>
            <p className="font-bold">デモモードで動作中</p>
            <p>data.csvが見つからないためサンプルデータを表示しています。</p>
          </div>
        </div>
        )}

        {/* --- SETTINGS / IMPORT MODE --- */}
        {mode === 'settings' ? (
        <div className="space-y-6 animate-fadeIn">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
              <FileText className="w-5 h-5 text-indigo-600" />
              データの読み込み
            </h2>

            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-6 text-sm text-blue-800">
              <p className="font-bold flex items-center gap-2 mb-1">
                <Info className="w-4 h-4" />
                自動読み込みについて
              </p>
              <p className="text-xs leading-relaxed opacity-90">
                アプリと同じ場所に <code>data.csv</code> を置くと自動で読み込まれます。<br />
                音声ファイルは <code>1.mp3</code> のようにIDに対応するファイル名で置いてください。<br />
                ファイルがない場合は以下の手動入力も可能です。
              </p>
            </div>

            <div className="mb-6">
              <label className="block text-sm font-bold text-gray-700 mb-2">
                手動でCSVデータを貼り付け
              </label>
              <div
                className="bg-gray-50 p-3 rounded text-xs text-gray-500 mb-2 font-mono overflow-x-auto whitespace-pre">
                形式: ID | 全文 | 訳 | チャンク...<br />
                例: 1 | Hello. | こんにちは | Hello^Greeting^core^やあ
              </div>
              <textarea
                className="w-full h-32 p-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono"
                placeholder="ここにデータを貼り付けてください..." value={csvInput} onChange={(e)=> setCsvInput(e.target.value)}
                />
                {importError && (
                  <p className="text-red-500 text-xs mt-2">{importError}</p>
                )}
                <button
                  onClick={() => parseCSV(csvInput)}
                  className="mt-3 w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2"
                >
                  <Save className="w-4 h-4" />
                  CSVを反映する
                </button>
              </div>

              <div className="border-t pt-6">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                    <Music className="w-4 h-4 text-pink-500" />
                    手動で音声ファイルを選択
                  </h3>
                  {Object.keys(audioMap).length > 0 && (
                     <button onClick={clearAudioData} className="text-xs text-red-500 flex items-center gap-1">
                       <Trash2 className="w-3 h-3" /> クリア
                     </button>
                  )}
                </div>
                
                <p className="text-xs text-gray-500 mb-3">
                  自動読み込みが使えない場合などは、ここでファイルを選択してください。
                </p>
                <label className="block w-full cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 py-4 px-4 rounded-lg border-2 border-dashed border-gray-300 text-center transition">
                  <span className="flex items-center justify-center gap-2 text-sm">
                    <Upload className="w-4 h-4" /> ファイルを選択 (複数選択OK)
                  </span>
                  <input 
                    type="file" 
                    accept="audio/*" 
                    multiple 
                    className="hidden" 
                    onChange={handleAudioUpload} 
                  />
                </label>
                {Object.keys(audioMap).length > 0 && (
                  <div className="mt-3 text-xs text-green-600 font-bold text-center">
                    {Object.keys(audioMap).length} 個のファイルがリンク済み
                  </div>
                )}
              </div>
            </div>
            
            <button
              onClick={() => {
                setSentences(DEFAULT_SENTENCES);
                setAudioMap({});
                setIsDataLoaded(false);
              }}
              className="w-full py-3 text-sm text-gray-500 hover:text-red-500 transition"
            >
              デモデータに戻す
            </button>
          </div>
        ) : (
          /* --- STUDY & QUIZ MODES --- */
          <>
            {/* Sentence Navigation */}
            <div className="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm">
              <button 
                onClick={() => setCurrentIndex(prev => Math.max(0, prev - 1))}
                disabled={currentIndex === 0}
                className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30 transition"
              >
                <ChevronLeft className="w-6 h-6 text-indigo-600" />
              </button>
              <div className="text-center">
                <span className="font-semibold text-gray-500 block text-sm">
                  ID: {currentSentence.id}
                </span>
                <span className="text-xs text-indigo-400 font-bold">{currentIndex + 1} / {sentences.length}</span>
              </div>
              <button 
                onClick={() => setCurrentIndex(prev => Math.min(sentences.length - 1, prev + 1))}
                disabled={currentIndex === sentences.length - 1}
                className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30 transition"
              >
                <ChevronRight className="w-6 h-6 text-indigo-600" />
              </button>
            </div>

            {/* Mode Switcher */}
            <div className="flex bg-gray-200 p-1 rounded-lg">
              <button
                onClick={() => setMode('study')}
                className={`flex-1 py-2 rounded-md text-sm font-medium transition flex justify-center items-center gap-2 ${mode === 'study' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}
              >
                <BookOpen className="w-4 h-4" />
                構造理解
              </button>
              <button
                onClick={() => setMode('quiz')}
                className={`flex-1 py-2 rounded-md text-sm font-medium transition flex justify-center items-center gap-2 ${mode === 'quiz' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}
              >
                <Ear className="w-4 h-4" />
                整序クイズ
              </button>
            </div>

            {/* Content Area */}
            {mode === 'study' ? (
              <div className="space-y-6 animate-fadeIn">
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                  <div className="flex flex-wrap gap-2 mb-4">
                    {currentSentence.chunks.map((chunk, idx) => (
                      <div key={idx} className="group relative cursor-pointer" onClick={() => speakText(chunk.text)}>
                        <span className={`inline-block px-2 py-1 rounded border-b-2 text-lg font-medium transition-all hover:opacity-80 ${TYPE_COLORS[chunk.type] || "bg-gray-100"}`}>
                          {chunk.text}
                        </span>
                        <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none z-20 shadow-lg">
                          <p className="font-bold text-center">{chunk.label}</p>
                          <p className="text-gray-300 text-center">{chunk.japanese}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                  <p className="text-gray-500 text-sm mt-4 border-t pt-3 flex items-center gap-2">
                    <Info className="w-4 h-4" />
                    ブロックをタップで発音 (TTS)
                  </p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                  <h3 className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-1">Meaning</h3>
                  <p className="text-gray-700 font-medium">{currentSentence.translation}</p>
                </div>

                {/* Player Controls */}
                <div className="space-y-3">
                    {/* Native Audio Button (Priority) */}
                    <button
                      onClick={isNativePlaying ? stopNativeAudio : playNativeAudio}
                      disabled={nativeAudioError}
                      className={`w-full flex items-center justify-center p-4 rounded-xl border-2 transition gap-3
                        ${nativeAudioError ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed' : 
                          isNativePlaying ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-slate-800 border-slate-800 text-white shadow-md hover:bg-slate-700'}
                      `}
                    >
                      {isNativePlaying ? <Pause className="w-6 h-6" /> : <Music className="w-6 h-6" />}
                      <div className="text-left">
                        <span className="block text-sm font-bold">Native Audio</span>
                        <span className="block text-xs opacity-80">
                          {nativeAudioError ? "音声ファイルなし (例: 1.mp3)" : "音声ファイル再生"}
                        </span>
                      </div>
                    </button>

                    <div className="grid grid-cols-2 gap-3">
                      <button
                        onClick={() => isPlaying ? cancelSpeech() : speakText(currentSentence.text, playbackRate)}
                        className={`flex flex-col items-center justify-center p-3 rounded-xl border-2 transition ${isPlaying ? 'border-indigo-400 bg-indigo-50 text-indigo-600' : 'border-indigo-100 bg-white hover:bg-indigo-50 text-indigo-600'}`}
                      >
                         <span className="text-sm font-bold">TTS 全文</span>
                      </button>

                      <button
                        onClick={speakChunksWithPause}
                        className="flex flex-col items-center justify-center p-3 rounded-xl border-2 border-teal-100 bg-white hover:bg-teal-50 text-teal-600 transition"
                      >
                        <span className="text-sm font-bold">TTS 区切り</span>
                      </button>
                    </div>
                </div>
                
                <div className="bg-white px-4 py-3 rounded-xl shadow-sm flex items-center gap-4">
                  <span className="text-xs font-bold text-gray-400">TTS SPEED</span>
                  <input 
                    type="range" min="0.5" max="1.5" step="0.1" 
                    value={playbackRate}
                    onChange={(e) => setPlaybackRate(parseFloat(e.target.value))}
                    className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                  />
                  <span className="text-xs font-mono w-8 text-right">{playbackRate}x</span>
                </div>
              </div>
            ) : (
              /* QUIZ MODE */
              <div className="space-y-6 animate-fadeIn">
                <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 text-center">
                  <p className="text-sm text-orange-800 mb-2">音声を聞いて、正しい順序に並べ替えよう！</p>
                  <div className="flex justify-center gap-2">
                    {/* Native Audio Priority in Quiz */}
                    <button
                        onClick={isNativePlaying ? stopNativeAudio : playNativeAudio}
                        disabled={nativeAudioError}
                        className={`inline-flex items-center gap-2 px-4 py-2 rounded-full font-bold shadow-sm transition
                          ${nativeAudioError ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-slate-800 text-white hover:bg-slate-700 active:scale-95'}
                        `}
                      >
                        {isNativePlaying ? <Pause className="w-4 h-4" /> : <Music className="w-4 h-4" />}
                        Native Audio
                      </button>

                    <button
                      onClick={() => speakText(currentSentence.text, playbackRate)}
                      className="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-full text-orange-600 font-bold shadow-sm border border-orange-200 hover:bg-orange-100 active:scale-95 transition"
                    >
                      <Play className="w-4 h-4" /> TTS (Robot)
                    </button>
                  </div>
                </div>

                <div className="min-h-[120px] bg-white border-2 border-dashed border-gray-300 rounded-xl p-4 flex flex-wrap content-start gap-2">
                  {selectedChunks.length === 0 && (
                    <div className="w-full h-full flex items-center justify-center text-gray-400 text-sm">
                      チャンクを選んで並べ替え
                    </div>
                  )}
                  {selectedChunks.map((chunk) => (
                    <button
                      key={`sel-${chunk.id}`}
                      onClick={() => handleChunkDeselect(chunk)}
                      className={`px-3 py-2 rounded shadow-sm text-sm font-medium animate-popIn ${TYPE_COLORS[chunk.type]}`}
                    >
                      {chunk.text}
                    </button>
                  ))}
                </div>

                <div className="flex flex-wrap gap-2">
                  {shuffledChunks.map((chunk) => (
                    <button
                      key={`shuf-${chunk.id}`}
                      onClick={() => handleChunkSelect(chunk)}
                      className="px-3 py-2 bg-white border border-gray-200 rounded shadow-sm text-gray-700 text-sm hover:bg-gray-50 active:scale-95 transition"
                    >
                      {chunk.text}
                    </button>
                  ))}
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={resetQuiz}
                    className="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300 transition flex items-center justify-center gap-2"
                  >
                    <RotateCcw className="w-4 h-4" /> Reset
                  </button>
                  <button
                    onClick={checkAnswer}
                    disabled={shuffledChunks.length > 0 || quizResult === 'correct'}
                    className={`flex-1 py-3 rounded-xl font-bold text-white shadow-md transition flex items-center justify-center gap-2
                      ${shuffledChunks.length > 0 ? 'bg-gray-300 cursor-not-allowed' : quizResult === 'correct' ? 'bg-green-500' : 'bg-indigo-600 hover:bg-indigo-700'}
                    `}
                  >
                    {quizResult === 'correct' ? <Check className="w-5 h-5" /> : <ArrowRight className="w-5 h-5" />}
                    Check
                  </button>
                </div>

                {quizResult === 'incorrect' && (
                  <div className="text-center text-red-500 font-bold animate-shake">
                    Not quite right. Try again!
                  </div>
                )}
                {quizResult === 'correct' && (
                  <div className="bg-green-50 p-4 rounded-xl border border-green-100 text-center animate-bounceIn">
                    <p className="text-green-800 font-bold mb-1">Excellent!</p>
                    <p className="text-green-600 text-sm">{currentSentence.translation}</p>
                    <button 
                      onClick={() => {
                        setCurrentIndex(prev => Math.min(sentences.length - 1, prev + 1));
                        setMode('study');
                      }}
                      className="mt-3 text-xs bg-white border border-green-200 text-green-700 px-3 py-1 rounded-full"
                    >
                      Next Sentence &rarr;
                    </button>
                  </div>
                )}
              </div>
            )}
          </>
        )}
      </main>

      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
          0% { transform: scale(0.8); opacity: 0; }
          100% { transform: scale(1); opacity: 1; }
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-popIn { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-shake { animation: shake 0.3s ease-in-out; }
      `}</style>
    </div>
  );
}