<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Chunk Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-popIn { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-shake { animation: shake 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const IconBase = ({ children, className }) => <span className={`inline-flex items-center justify-center ${className}`}>{children}</span>;
        const Play = ({ className }) => <IconBase className={className}>â–¶</IconBase>;
        const Pause = ({ className }) => <IconBase className={className}>â¸</IconBase>;
        const RotateCcw = ({ className }) => <IconBase className={className}>â†º</IconBase>;
        const Check = ({ className }) => <IconBase className={className}>âœ“</IconBase>;
        const ArrowRight = ({ className }) => <IconBase className={className}>â†’</IconBase>;
        const BookOpen = ({ className }) => <IconBase className={className}>ğŸ“–</IconBase>;
        const Ear = ({ className }) => <IconBase className={className}>ğŸ‘‚</IconBase>;
        const Info = ({ className }) => <IconBase className={className}>â„¹ï¸</IconBase>;
        const Settings = ({ className }) => <IconBase className={className}>âš™ï¸</IconBase>;
        const ChevronRight = ({ className }) => <IconBase className={className}>â€º</IconBase>;
        const ChevronLeft = ({ className }) => <IconBase className={className}>â€¹</IconBase>;
        const Upload = ({ className }) => <IconBase className={className}>ğŸ“¤</IconBase>;
        const FileText = ({ className }) => <IconBase className={className}>ğŸ“„</IconBase>;
        const Music = ({ className }) => <IconBase className={className}>ğŸµ</IconBase>;
        const X = ({ className }) => <IconBase className={className}>âœ•</IconBase>;
        const Save = ({ className }) => <IconBase className={className}>ğŸ’¾</IconBase>;
        const Trash2 = ({ className }) => <IconBase className={className}>ğŸ—‘</IconBase>;
        const Loader2 = ({ className }) => <IconBase className={`${className} animate-spin`}>âŒ›</IconBase>;
        const AlertCircle = ({ className }) => <IconBase className={className}>âš ï¸</IconBase>;
        const ListIcon = ({ className }) => <IconBase className={className}>â˜°</IconBase>;

        // --- åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ (ãƒ‡ãƒ¢ç”¨) ---
        const DEFAULT_SENTENCES = [
            {
                id: 1,
                level: "Basic",
                text: "My children are so absorbed in their iPads.",
                translation: "å­ä¾›ãŸã¡ã¯iPadã«å¤¢ä¸­ã§ã™ã€‚",
                chunks: [
                    { text: "My children are", label: "Subject + Verb", type: "core", japanese: "ç§ã®å­ä¾›ãŸã¡ã¯ï½ã§ã™" },
                    { text: "so absorbed", label: "Adjective", type: "core", japanese: "ã¨ã¦ã‚‚å¤¢ä¸­ãª" },
                    { text: "in their iPads.", label: "Preposition", type: "modifier", japanese: "å½¼ã‚‰ã®iPadã«" }
                ]
            }
        ];

        // è‰²åˆ†ã‘è¨­å®š
        const TYPE_COLORS = {
            core: "bg-red-100 text-red-800 border-red-200",
            modifier: "bg-green-100 text-green-800 border-green-200",
            connector: "bg-blue-100 text-blue-800 border-blue-200"
        };

        function EnglishChunkMaster() {
            // --- State ---
            const [sentences, setSentences] = useState(DEFAULT_SENTENCES);
            const [isLoading, setIsLoading] = useState(true);
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [mode, setMode] = useState('study'); 
            const [isPlaying, setIsPlaying] = useState(false);
            const [playbackRate, setPlaybackRate] = useState(1.0);
            const [isNativePlaying, setIsNativePlaying] = useState(false);
            const [nativeAudioError, setNativeAudioError] = useState(false);
            
            const [audioMap, setAudioMap] = useState({});
            const audioPlayerRef = useRef(null);
            const [csvInput, setCsvInput] = useState("");
            const [importError, setImportError] = useState(null);

            const [shuffledChunks, setShuffledChunks] = useState([]);
            const [selectedChunks, setSelectedChunks] = useState([]);
            const [quizResult, setQuizResult] = useState(null);
            const [jumpIdInput, setJumpIdInput] = useState("");

            const currentSentence = sentences[currentIndex] || sentences[0];
            const synthesisRef = useRef(window.speechSynthesis);

            const nativeAudioSrc = audioMap[currentSentence.id] || `./audio/${currentSentence.id}.mp3`;

            // --- Effects ---
            useEffect(() => {
                const autoLoadData = async () => {
                    try {
                        setIsLoading(true);
                        const response = await fetch('data.csv');
                        if (!response.ok) throw new Error("data.csv not found");
                        const text = await response.text();
                        if (!text.trim()) throw new Error("Empty CSV");
                        const loaded = parseCSV(text, true);
                        if (loaded) {
                            setIsDataLoaded(true);
                            console.log("Auto-loaded data.csv successfully.");
                        }
                    } catch (error) {
                        console.log("Auto-load failed or no data.csv found. Using demo mode.", error);
                        setIsDataLoaded(false);
                    } finally {
                        setIsLoading(false);
                    }
                };
                autoLoadData();
            }, []);

            useEffect(() => {
                return () => {
                    cancelSpeech();
                    Object.values(audioMap).forEach(url => URL.revokeObjectURL(url));
                };
            }, []);

            useEffect(() => {
                resetQuiz();
                cancelSpeech();
                stopNativeAudio();
                setNativeAudioError(false);
            }, [currentIndex, mode, sentences]);

            // --- Functions ---
            const handleJumpToId = () => {
                const idToJump = parseInt(jumpIdInput, 10);
                if (isNaN(idToJump)) return;

                const targetIndex = sentences.findIndex(s => s.id === idToJump);

                if (targetIndex !== -1) {
                    setCurrentIndex(targetIndex);
                } else {
                    alert(`ID ${idToJump} ã®å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                }
                setJumpIdInput("");
            };

            const handleJumpInputKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleJumpToId();
                }
            };
            
            const parseCSV = (text, isAutoLoad = false) => {
                try {
                    const lines = text.trim().split('\n');
                    const newSentences = lines.map((line, index) => {
                        const cleanLine = line.trim().replace(/^\uFEFF/, '');
                        if (index === 0 && (cleanLine.toLowerCase().startsWith('id') || cleanLine.includes('è‹±æ–‡'))) return null;

                        const parts = line.split('|').map(p => p.trim());
                        if (parts.length < 3) return null;

                        let idVal = parseInt(parts[0], 10);
                        let startIndex = 1;
                        if (isNaN(idVal)) {
                            idVal = Date.now() + index;
                            startIndex = 0;
                        }

                        const sentenceText = parts[startIndex];
                        const translation = parts[startIndex + 1];
                        const chunkRawData = parts.slice(startIndex + 2);
                        const chunks = chunkRawData.map(chunkStr => {
                            const [cText, cLabel, cType, cJp] = chunkStr.split('^').map(s => s?.trim());
                            return {
                                text: cText || "",
                                label: cLabel || "",
                                type: (cType === 'core' || cType === 'modifier' || cType === 'connector') ? cType : 'core',
                                japanese: cJp || ""
                            };
                        }).filter(c => c.text);

                        return { id: idVal, level: "Custom", text: sentenceText, translation: translation, chunks: chunks };
                    }).filter(Boolean);

                    if (newSentences.length === 0) throw new Error("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");

                    setSentences(newSentences);
                    setCurrentIndex(0);
                    setMode('study');
                    setImportError(null);

                    if (!isAutoLoad) alert(`${newSentences.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`);
                    return true;
                } catch (e) {
                    setImportError(e.message);
                    if (!isAutoLoad) alert(e.message);
                    return false;
                }
            };

            const handleAudioUpload = (e) => {
                const files = Array.from(e.target.files);
                const newAudioMap = { ...audioMap };
                let count = 0;
                files.forEach(file => {
                    const match = file.name.match(/\((\d+)\)/) || file.name.match(/(\d+)/);
                    if (match) {
                        const id = parseInt(match[1], 10);
                        if (newAudioMap[id]) URL.revokeObjectURL(newAudioMap[id]);
                        newAudioMap[id] = URL.createObjectURL(file);
                        count++;
                    }
                });
                setAudioMap(newAudioMap);
                alert(`${count} å€‹ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒ³ã‚¯ã—ã¾ã—ãŸï¼`);
            };

            const clearAudioData = () => {
                Object.values(audioMap).forEach(url => URL.revokeObjectURL(url));
                setAudioMap({});
            };

            const playNativeAudio = () => {
                cancelSpeech();
                if (audioPlayerRef.current && nativeAudioSrc && !nativeAudioError) {
                    audioPlayerRef.current.play().then(() => {
                        setIsNativePlaying(true);
                    }).catch(e => {
                        console.error("Audio playback error:", e);
                        setNativeAudioError(true);
                    });
                }
            };

            const stopNativeAudio = () => {
                if (audioPlayerRef.current) {
                    audioPlayerRef.current.pause();
                    audioPlayerRef.current.currentTime = 0;
                }
                setIsNativePlaying(false);
            };

            const cancelSpeech = () => {
                if (synthesisRef.current) {
                    synthesisRef.current.cancel();
                    setIsPlaying(false);
                }
            };

            const speakText = (text, rate = 1.0, onEnd = () => {}) => {
                stopNativeAudio();
                cancelSpeech();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rate;
                utterance.onend = () => {
                    setIsPlaying(false);
                    onEnd();
                };
                utterance.onerror = () => setIsPlaying(false);
                setIsPlaying(true);
                synthesisRef.current.speak(utterance);
            };

            const speakChunksWithPause = async () => {
                stopNativeAudio();
                cancelSpeech();
                setIsPlaying(true);
                const speakChunk = (index) => {
                    if (index >= currentSentence.chunks.length) {
                        setIsPlaying(false);
                        return;
                    }
                    const chunk = currentSentence.chunks[index];
                    const utterance = new SpeechSynthesisUtterance(chunk.text);
                    utterance.lang = 'en-US';
                    utterance.rate = playbackRate * 0.9;
                    utterance.onend = () => {
                        setTimeout(() => speakChunk(index + 1), 800);
                    };
                    synthesisRef.current.speak(utterance);
                };
                speakChunk(0);
            };

            const resetQuiz = () => {
                if (!currentSentence) return;
                const chunksWithId = currentSentence.chunks.map((c, i) => ({ ...c, id: i }));
                const shuffled = [...chunksWithId].sort(() => Math.random() - 0.5);
                setShuffledChunks(shuffled);
                setSelectedChunks([]);
                setQuizResult(null);
            };

            const handleChunkSelect = (chunk) => {
                if (quizResult === 'correct') return;
                setShuffledChunks(prev => prev.filter(c => c.id !== chunk.id));
                setSelectedChunks(prev => [...prev, chunk]);
            };

            const handleChunkDeselect = (chunk) => {
                if (quizResult === 'correct') return;
                setSelectedChunks(prev => prev.filter(c => c.id !== chunk.id));
                setShuffledChunks(prev => [...prev, chunk]);
            };

                        const checkAnswer = () => {

                            const currentAnswer = selectedChunks.map(c => c.text).join(' ');

                            const normalize = str => str.replace(/[.,]/g, '').trim().toLowerCase();

                            const isCorrect = normalize(currentAnswer) === normalize(currentSentence.text);

            

                            setQuizResult(isCorrect ? 'correct' : 'incorrect');

                        };

            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 text-gray-500">
                        <div className="flex flex-col items-center gap-2">
                            <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
                            <p className="text-sm font-medium">Loading data...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-20">
                    <audio ref={audioPlayerRef} src={nativeAudioSrc} onEnded={()=> setIsNativePlaying(false)} onError={() => { setIsNativePlaying(false); setNativeAudioError(true); }} />

                    <header className="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-20">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <h1 className="text-lg font-bold flex items-center gap-2">
                                <Settings className="w-5 h-5 text-indigo-400" />
                                English Chunk Master
                            </h1>
                            <div className="flex items-center gap-2">
                                {isDataLoaded ? <span className="text-[10px] bg-green-600 px-2 py-0.5 rounded-full font-bold">CSVèª­è¾¼æ¸ˆ</span> : <span className="text-[10px] bg-gray-600 px-2 py-0.5 rounded-full font-bold">ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</span>}
                                <button onClick={()=> setMode(mode === 'settings' ? 'study' : 'settings')} className={`p-2 rounded-full transition ${mode === 'settings' ? 'bg-slate-600' : 'hover:bg-slate-700'}`}>
                                    {mode === 'settings' ? <X className="w-5 h-5" /> : <Settings className="w-5 h-5" />}
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">
                        {!isDataLoaded && mode !== 'settings' && (
                            <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 text-xs p-3 rounded-lg flex items-start gap-2 animate-fadeIn">
                                <AlertCircle className="w-4 h-4 shrink-0 mt-0.5" />
                                <div><p className="font-bold">ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­</p><p>data.csvãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p></div>
                            </div>
                        )}

                        {mode === 'settings' ? (
                            <div className="space-y-6 animate-fadeIn">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><FileText className="w-5 h-5 text-indigo-600" />ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</h2>
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-6 text-sm text-blue-800">
                                        <p className="font-bold flex items-center gap-2 mb-1"><Info className="w-4 h-4" />è‡ªå‹•èª­ã¿è¾¼ã¿ã«ã¤ã„ã¦</p>
                                        <p className="text-xs leading-relaxed opacity-90">ã‚¢ãƒ—ãƒªã¨åŒã˜å ´æ‰€ã« <code>data.csv</code> ã‚’ç½®ãã¨è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚<br />éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¯ <code>1.mp3</code> ã®ã‚ˆã†ã«IDã«å¯¾å¿œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã§ç½®ã„ã¦ãã ã•ã„ã€‚</p>
                                    </div>
                                    <div className="mb-6">
                                        <label className="block text-sm font-bold text-gray-700 mb-2">æ‰‹å‹•ã§CSVãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘</label>
                                        <div className="bg-gray-50 p-3 rounded text-xs text-gray-500 mb-2 font-mono overflow-x-auto whitespace-pre">
                                            å½¢å¼: ID | å…¨æ–‡ | è¨³ | ãƒãƒ£ãƒ³ã‚¯...<br />ä¾‹: 1 | Hello. | ã“ã‚“ã«ã¡ã¯ | Hello^Greeting^core^ã‚„ã‚
                                        </div>
                                        <textarea className="w-full h-32 p-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono" placeholder="ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..." value={csvInput} onChange={(e)=> setCsvInput(e.target.value)} />
                                        {importError && <p className="text-red-500 text-xs mt-2">{importError}</p>}
                                        <button onClick={() => parseCSV(csvInput)} className="mt-3 w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2"><Save className="w-4 h-4" />CSVã‚’åæ˜ ã™ã‚‹</button>
                                    </div>
                                    <div className="border-t pt-6">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="text-sm font-bold text-gray-700 flex items-center gap-2"><Music className="w-4 h-4 text-pink-500" />æ‰‹å‹•ã§éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h3>
                                            {Object.keys(audioMap).length > 0 && <button onClick={clearAudioData} className="text-xs text-red-500 flex items-center gap-1"><Trash2 className="w-3 h-3" /> ã‚¯ãƒªã‚¢</button>}
                                        </div>
                                        <p className="text-xs text-gray-500 mb-3">è‡ªå‹•èª­ã¿è¾¼ã¿ãŒä½¿ãˆãªã„å ´åˆãªã©ã¯ã€ã“ã“ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                                        <label className="block w-full cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 py-4 px-4 rounded-lg border-2 border-dashed border-gray-300 text-center transition">
                                            <span className="flex items-center justify-center gap-2 text-sm"><Upload className="w-4 h-4" /> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (è¤‡æ•°é¸æŠOK)</span>
                                            <input type="file" accept="audio/*" multiple className="hidden" onChange={handleAudioUpload} />
                                        </label>
                                        {Object.keys(audioMap).length > 0 && <div className="mt-3 text-xs text-green-600 font-bold text-center">{Object.keys(audioMap).length} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªãƒ³ã‚¯æ¸ˆã¿</div>}
                                    </div>
                                </div>
                                <button onClick={() => { setSentences(DEFAULT_SENTENCES); setAudioMap({}); setIsDataLoaded(false); }} className="w-full py-3 text-sm text-gray-500 hover:text-red-500 transition">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™</button>
                            </div>
                        ) : (
                            <>
                                {/* --- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ --- */}
                                <div className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm gap-2">
                                    <button onClick={() => setCurrentIndex(prev => Math.max(0, prev - 1))} disabled={currentIndex === 0} className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30 transition flex-shrink-0"><ChevronLeft className="w-6 h-6 text-indigo-600" /></button>
                                    
                                    <div className="flex-1 flex items-center gap-2 min-w-0">
                                        {/* å•é¡Œé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */}
                                        <div className="flex-1 min-w-0 bg-gray-100 rounded-lg relative">
                                            <select 
                                                value={currentIndex} 
                                                onChange={(e) => setCurrentIndex(Number(e.target.value))}
                                                className="w-full h-full bg-transparent p-2 text-sm text-gray-700 font-bold appearance-none outline-none truncate pr-8 z-10 relative cursor-pointer"
                                            >
                                                {sentences.map((sentence, idx) => (
                                                    <option key={sentence.id} value={idx}>
                                                        {idx + 1}. [ID:{sentence.id}] {sentence.text.slice(0, 20)}{sentence.text.length > 20 ? '...' : ''}
                                                    </option>
                                                ))}
                                            </select>
                                            <div className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                                                <ListIcon className="w-4 h-4" />
                                            </div>
                                        </div>

                                        {/* IDã‚¸ãƒ£ãƒ³ãƒ—å…¥åŠ› */}
                                        <div className="flex items-center gap-1">
                                            <input
                                                type="number"
                                                value={jumpIdInput}
                                                onChange={(e) => setJumpIdInput(e.target.value)}
                                                onKeyDown={handleJumpInputKeyDown}
                                                className="w-20 p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                                placeholder="ID Jump"
                                            />
                                            <button
                                                onClick={handleJumpToId}
                                                className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-bold"
                                            >
                                                Go
                                            </button>
                                        </div>
                                    </div>

                                    <button onClick={() => setCurrentIndex(prev => Math.min(sentences.length - 1, prev + 1))} disabled={currentIndex === sentences.length - 1} className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30 transition flex-shrink-0"><ChevronRight className="w-6 h-6 text-indigo-600" /></button>
                                </div>

                                <div className="flex bg-gray-200 p-1 rounded-lg">
                                    <button onClick={() => setMode('study')} className={`flex-1 py-2 rounded-md text-sm font-medium transition flex justify-center items-center gap-2 ${mode === 'study' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}><BookOpen className="w-4 h-4" />æ§‹é€ ç†è§£</button>
                                    <button onClick={() => setMode('quiz')} className={`flex-1 py-2 rounded-md text-sm font-medium transition flex justify-center items-center gap-2 ${mode === 'quiz' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}><Ear className="w-4 h-4" />æ•´åºã‚¯ã‚¤ã‚º</button>
                                </div>

                                {mode === 'study' ? (
                                    <div className="space-y-6 animate-fadeIn">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                            <div className="flex flex-wrap gap-2 mb-4">
                                                {currentSentence.chunks.map((chunk, idx) => (
                                                    <div key={idx} className="group relative cursor-pointer" onClick={() => speakText(chunk.text)}>
                                                        <span className={`inline-block px-2 py-1 rounded border-b-2 text-lg font-medium transition-all hover:opacity-80 ${TYPE_COLORS[chunk.type] || "bg-gray-100"}`}>{chunk.text}</span>
                                                        <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none z-20 shadow-lg"><p className="font-bold text-center">{chunk.label}</p><p className="text-gray-300 text-center">{chunk.japanese}</p></div>
                                                    </div>
                                                ))}
                                            </div>
                                            <p className="text-gray-500 text-sm mt-4 border-t pt-3 flex items-center gap-2"><Info className="w-4 h-4" />ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚¿ãƒƒãƒ—ã§ç™ºéŸ³ (TTS)</p>
                                        </div>

                                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><h3 className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-1">Meaning</h3><p className="text-gray-700 font-medium">{currentSentence.translation}</p></div>

                                        <div className="space-y-3">
                                            <button onClick={isNativePlaying ? stopNativeAudio : playNativeAudio} disabled={nativeAudioError} className={`w-full flex items-center justify-center p-4 rounded-xl border-2 transition gap-3 ${nativeAudioError ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed' : isNativePlaying ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-slate-800 border-slate-800 text-white shadow-md hover:bg-slate-700'}`}>
                                                {isNativePlaying ? <Pause className="w-6 h-6" /> : <Music className="w-6 h-6" />}
                                                <div className="text-left"><span className="block text-sm font-bold">Native Audio</span><span className="block text-xs opacity-80">{nativeAudioError ? "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãªã— (ä¾‹: 1.mp3)" : "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿ"}</span></div>
                                            </button>

                                            <div className="grid grid-cols-2 gap-3">
                                                <button onClick={() => isPlaying ? cancelSpeech() : speakText(currentSentence.text, playbackRate)} className={`flex flex-col items-center justify-center p-3 rounded-xl border-2 transition ${isPlaying ? 'border-indigo-400 bg-indigo-50 text-indigo-600' : 'border-indigo-100 bg-white hover:bg-indigo-50 text-indigo-600'}`}><span className="text-sm font-bold">TTS å…¨æ–‡</span></button>
                                                <button onClick={speakChunksWithPause} className="flex flex-col items-center justify-center p-3 rounded-xl border-2 border-teal-100 bg-white hover:bg-teal-50 text-teal-600 transition"><span className="text-sm font-bold">TTS åŒºåˆ‡ã‚Š</span></button>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white px-4 py-3 rounded-xl shadow-sm flex items-center gap-4">
                                            <span className="text-xs font-bold text-gray-400">TTS SPEED</span>
                                            <input type="range" min="0.5" max="1.5" step="0.1" value={playbackRate} onChange={(e) => setPlaybackRate(parseFloat(e.target.value))} className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                            <span className="text-xs font-mono w-8 text-right">{playbackRate}x</span>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-6 animate-fadeIn">
                                        <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 text-center">
                                            <p className="text-sm text-orange-800 mb-2">éŸ³å£°ã‚’èã„ã¦ã€æ­£ã—ã„é †åºã«ä¸¦ã¹æ›¿ãˆã‚ˆã†ï¼</p>
                                            <div className="flex justify-center gap-2">
                                                <button onClick={isNativePlaying ? stopNativeAudio : playNativeAudio} disabled={nativeAudioError} className={`inline-flex items-center gap-2 px-4 py-2 rounded-full font-bold shadow-sm transition ${nativeAudioError ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-slate-800 text-white hover:bg-slate-700 active:scale-95'}`}>{isNativePlaying ? <Pause className="w-4 h-4" /> : <Music className="w-4 h-4" />} Native Audio</button>
                                                <button onClick={() => speakText(currentSentence.text, playbackRate)} className="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-full text-orange-600 font-bold shadow-sm border border-orange-200 hover:bg-orange-100 active:scale-95 transition"><Play className="w-4 h-4" /> TTS (Robot)</button>
                                            </div>
                                        </div>

                                        <div className="min-h-[120px] bg-white border-2 border-dashed border-gray-300 rounded-xl p-4 flex flex-wrap content-start gap-2">
                                            {selectedChunks.length === 0 && <div className="w-full h-full flex items-center justify-center text-gray-400 text-sm">ãƒãƒ£ãƒ³ã‚¯ã‚’é¸ã‚“ã§ä¸¦ã¹æ›¿ãˆ</div>}
                                            {selectedChunks.map((chunk) => (
                                                <button key={`sel-${chunk.id}`} onClick={() => handleChunkDeselect(chunk)} className={`px-3 py-2 rounded shadow-sm text-sm font-medium animate-popIn ${TYPE_COLORS[chunk.type]}`}>{chunk.text}</button>
                                            ))}
                                        </div>

                                        <div className="flex flex-wrap gap-2">
                                            {shuffledChunks.map((chunk) => (
                                                <button key={`shuf-${chunk.id}`} onClick={() => handleChunkSelect(chunk)} className="px-3 py-2 bg-white border border-gray-200 rounded shadow-sm text-gray-700 text-sm hover:bg-gray-50 active:scale-95 transition">{chunk.text}</button>
                                            ))}
                                        </div>

                                        <div className="flex gap-3">
                                            <button onClick={resetQuiz} className="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300 transition flex items-center justify-center gap-2"><RotateCcw className="w-4 h-4" /> Reset</button>
                                            <button onClick={checkAnswer} disabled={shuffledChunks.length > 0 || quizResult === 'correct'} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-md transition flex items-center justify-center gap-2 ${shuffledChunks.length > 0 ? 'bg-gray-300 cursor-not-allowed' : quizResult === 'correct' ? 'bg-green-500' : 'bg-indigo-600 hover:bg-indigo-700'}`}>{quizResult === 'correct' ? <Check className="w-5 h-5" /> : <ArrowRight className="w-5 h-5" />} Check</button>
                                        </div>

                                        {quizResult === 'incorrect' && <div className="text-center text-red-500 font-bold animate-shake">Not quite right. Try again!</div>}
                                        {quizResult === 'correct' && (
                                            <div className="bg-green-50 p-4 rounded-xl border border-green-100 text-center animate-bounceIn">
                                                <p className="text-green-800 font-bold mb-1">Excellent!</p>
                                                <p className="text-green-600 text-sm">{currentSentence.translation}</p>
                                                <button onClick={() => { setCurrentIndex(prev => Math.min(sentences.length - 1, prev + 1)); setMode('study'); }} className="mt-3 text-xs bg-white border border-green-200 text-green-700 px-3 py-1 rounded-full">Next Sentence &rarr;</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnglishChunkMaster />);
    </script>
</body>
</html>